<?xml version="1.0" encoding="ISO-8859-1"?>
<project basedir="." default="MigrateData" name="CIAPL">

	<property name="sshtools.home" location="lib" />

    <property environment="env"/>

	<property file="build.properties"/>

    <!--Directorios com codigo fonte-->
    <property name="src" location="src" /> 
    <property name="src.tests" location="src_tests" /> 
    <property name="src.jsp" location="jsp" />
    <property name="metadata" location="metadata" />
    <property name="javadoc.source.home" location="javaDocSource" />
    <property name="javadoc.test.home" location="javaDocTests" />
    
	<property name="build.home" location="build"/>

    <!--Directorios destino da compilacao do projecto-->
    <property name="tests.classes" location="${build.home}/tests"/>
	<property name="webapp"          location="${build.home}/app"/>
    <property name="webapp.metadata" value="${webapp}/WEB-INF"/>
    <property name="webapp.classes"  value="${webapp.metadata}/classes"/>
    <property name="webapp.lib"      value="${webapp.metadata}/lib"/>    

    
	<!-- Directorys for deploy -->
	<property name="deploy.home" location="deploy"/>	
    <property name="deploy.jars"     value="${deploy.home}/jars"/>
	
    <!--Directorio com bibliotecas (JAR) a utilizar-->
    <property name="lib" location="lib" />
	<property location="lib_web" name="libs.web"/>

    <!--Directorio com configuracoes-->
    <property location="config" name="config"/>

    <!--Directorio com instrucoes SQL-->
    <property location="etc" name="sql"/>

    <!--Directorio com reports dos unit tests -->
    <property location="report" name="reports.tests"/>

    <!-- INTERFACE WEB -->
    <!--Directorios da aplicacao Web-->

  
	<!-- Compilation options -->
	<property name="compile.debug"       value="on"/>
  	<property name="compile.deprecation" value="on"/>
  	<property name="compile.optimize"    value="on"/>

	<property name="encoding" value="ISO-8859-15"/>	



  <target name="prepare">
    <!-- Create build directories as needed -->
	<mkdir dir="${tests.classes}"/>
	<mkdir dir="${webapp.classes}"/>	
	<mkdir dir="${webapp.lib}"/>	
	<mkdir dir="${deploy.home}"/>
    <!-- Copy external dependencies as required -->
    <!-- *** CUSTOMIZE HERE AS REQUIRED BY YOUR APPLICATION *** -->
    <copy todir="${webapp}">
    	<fileset dir="${basedir}/jsp"/>
    </copy>
    
    <copy todir="${webapp.metadata}">
    	<fileset dir="${basedir}/metadata"/>    
    </copy>

    <copy todir="${webapp.lib}">
    	<fileset dir="${basedir}/lib">    
    	      <exclude name="servlet.jar"/>
              <exclude name="strutstest.jar"/>
    	</fileset>
    	<fileset dir="${basedir}/lib_web">    
    	      <exclude name="servlet.jar"/>
              <exclude name="strutstest.jar"/>
    	</fileset>
    </copy>

	<copy todir="${webapp.classes}">
		<fileset dir="${basedir}/config"/>
	</copy>
    <!-- Copy static files from external dependencies as needed -->
    <!-- *** CUSTOMIZE HERE AS REQUIRED BY YOUR APPLICATION *** -->

  </target>
  
    <target name="compile-proj"
            description="Compila o projecto principal" depends="prepare">
        <tstamp />
        <javac destdir="${webapp.classes}"
               extdirs="${lib};${libs.web}"
               debug="${compile.debug}"
               optimize="${compile.optimize}"
               deprecation="${compile.deprecation}"
               encoding="${encoding}"
               memoryInitialSize="512m"
               memoryMaximumSize="512m" fork="yes">
			<src path="${src}"/>
        </javac>
		<replace 
	    	dir="${webapp.metadata}"
	    	propertyFile="build.properties">
	    	<include name="**/**/*.xml"/>
	    	<include name="**/**/ApplicationResources.properties"/>
	    	<include name="**/ServidorPersistenteConfig.properties"/>
	    	<include name="**/ServidorPersistenteOracleConfig.properties"/>
		  <replacefilter 
		    token="&lt;!-- @validation.doctype@ -->" property="validation.doctype"/>
		  <replacefilter 
		    token="@login.page@" 
		    property="login.page"/>
		  
		  <replacefilter 
		    token="@db.user@" 
		    property="db.user"/>
		  <replacefilter 
		    token="@db.pass@" 
		    property="db.pass"/>
		  <replacefilter 
		    token="@db.name@" 
		    property="db.name"/>
		  <replacefilter 
		    token="@db.alias@" 
		    property="db.alias"/>
		    		    
		  <replacefilter 
		    token="@application@" 
		    property="application"/>
		</replace>
    </target>


	<!-- Database targets -->
    <target name="prepare-tables"
            description="Alter existing tables to match new structure.">
        <sql
            driver="com.mysql.jdbc.Driver"
            url="jdbc:mysql://localhost/${db.name}"
            userid="${db.user}"
            password="${db.pass}"
            encoding="${encoding}">
	        <fileset dir="${sql}">
			 <include name="migrationNextSemester/runMeBeforeDataMigration.sql" />
  			</fileset>
            <classpath>
                <fileset dir="${lib}">
                    <include name="**/*.jar"/>
                </fileset>
            </classpath>
        </sql>
    </target>
   	
	<target name="MigrateData"
	        depends="compile-proj"
	        description="Imports data from external data sources"
	>
	<!-- Download data files -->
	
	<!-- Parse data files -->
	<!-- Migrate data -->
        <java classname="middleware.thor.LoadRamos"
			fork="yes"
			failonerror="true"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
        <java classname="middleware.thor.LoadNomeDisciplinas"
			fork="yes"
			failonerror="true"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>

        <java classname="middleware.thor.LoadDisciplinas"
			fork="yes"
			failonerror="true"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
        <java classname="middleware.thor.LoadExecutionCoursesAndAssociations"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>

	<!-- Restart tomcat -->
	
   	</target>   	
	
	<target name="updateMMA03-05"
	        depends="compile-proj"
	>
		<java classname="middleware.degreeCurricularPlan.DuplicateDegreeCurricularPlan"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
	
	</target>
	
	
	
	
	
	
	<!-- Targets for Student Migration -->
	
	
	<!-- Database targets -->
    <target name="create-tables"
            description="Cria as tabelas da base de dados.">
        <sql
            driver="com.mysql.jdbc.Driver"
            url="jdbc:mysql://localhost/${db.name}"
            userid="${db.user}"
            password="${db.pass}"
            encoding="${encoding}">
	        <fileset dir="${sql}">
			 <include name="middleware/commons/createTables.sql" />
  			</fileset>
            <classpath>
                <fileset dir="${lib}">
                    <include name="**/*.jar"/>
                </fileset>
            </classpath>
        </sql>
    </target>
	


    <target name="load-data-from-old-system"
    		depends="create-tables, replace-tokens"
            description="Carrega os dados nas tabelas">
        <sql
            driver="com.mysql.jdbc.Driver"
            url="jdbc:mysql://localhost/${db.name}"
            userid="${db.user}"
            password="${db.pass}"
            encoding="${encoding}">
	        <fileset dir="${sql}">
			 <include name="middleware/commons/PopulateTables_generated.sql" />
  			</fileset>
            <classpath>
                <fileset dir="${lib}">
                    <include name="**/*.jar"/>
                </fileset>
            </classpath>
        </sql>

    </target>


    <target name="load-data"
    		depends="load-data-from-old-system, clean-persons-with-duplicate-id"
            description="Carrega as tabelas e limpa as pessoas e alunos duplicados">
    </target>

	
	<!-- Database targets -->
    <target name="load-new-students"
    		depends="load-data"
            description="Carrega os novos alunos para a Tabela mw_STUDENT">
        <sql
            driver="com.mysql.jdbc.Driver"
            url="jdbc:mysql://localhost/${db.name}"
            userid="${db.user}"
            password="${db.pass}"
            encoding="${encoding}">
	        <fileset dir="${sql}">
			 <include name="middleware/others/LoadNewStudents.sql" />
  			</fileset>
            <classpath>
                <fileset dir="${lib}">
                    <include name="**/*.jar"/>
                </fileset>
            </classpath>
        </sql>
    </target>
	
	
	<target name="create-new-students"
	        depends="compile-proj, load-new-students">
		<java classname="middleware.studentMigration.CreateStudent"
			fork="yes"
			failonerror="false"
			maxmemory="512m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
	
	</target>
	
	


    <target name="load-existing-students"
    		depends="load-data"
            description="Carrega os Alunos que ja existem para a Tabela mw_STUDENT">
        <sql
            driver="com.mysql.jdbc.Driver"
            url="jdbc:mysql://localhost/${db.name}"
            userid="${db.user}"
            password="${db.pass}"
            encoding="${encoding}">
	        <fileset dir="${sql}">
			 <include name="middleware/others/LoadExistingStudents.sql" />
  			</fileset>
            <classpath>
                <fileset dir="${lib}">
                    <include name="**/*.jar"/>
                </fileset>
            </classpath>
        </sql>
    </target>



	<target name="update-existing-students" depends="compile-proj, load-existing-students">
		<java classname="middleware.studentMigration.UpdateStudent"
			fork="yes"
			failonerror="false"
			maxmemory="512m">

	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
	
	</target>





    <target name="load-new-ID-Students"
    		depends="load-data"
            description="Carrega os Alunos com novos BI's para a Tabela mw_STUDENT">
        <sql driver="com.mysql.jdbc.Driver"
            url="jdbc:mysql://localhost/${db.name}"
            userid="${db.user}"
            password="${db.pass}"
            encoding="${encoding}">
	        <fileset dir="${sql}">
			 <include name="middleware/others/LoadNewIDStudents.sql" />
  			</fileset>
            <classpath>
                <fileset dir="${lib}">
                    <include name="**/*.jar"/>
                </fileset>
            </classpath>
        </sql>
    </target>
	


	<target name="update-students-with-new-ID"
	        depends="compile-proj, load-new-ID-Students">
		<java classname="middleware.studentMigration.UpdateStudentIDNumbers"
			fork="yes"
			failonerror="false"
			maxmemory="512m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
	
	</target>

	<target name="update-students"
	        depends="compile-proj, update-students-with-new-ID, update-existing-students, create-new-students">
	</target>


	<target name="replace-tokens">
        <delete file="${sql}/middleware/commons/PopulateTables_generated.sql" />
		<copy file="${sql}/middleware/commons/PopulateTables.sql" toFile="${sql}/middleware/commons/PopulateTables_generated.sql" />		
		<replace dir="${sql}/middleware/commons"	propertyFile="middleware.properties">
	    	<include name="PopulateTables_generated.sql"/>
		    <replacefilter token="@load.data.infile.root@" property="load.data.infile.root"/>
		    <replacefilter token="@load.data.infile.rootIleec@" property="load.data.infile.rootIleec"/>
    	</replace>
	</target>


    <target name="load-semester-students">
        <sql driver="com.mysql.jdbc.Driver"
            url="jdbc:mysql://localhost/${db.name}"
            userid="${db.user}"
            password="${db.pass}"
            encoding="${encoding}">
	        <fileset dir="${sql}">
			 <include name="middleware/others/LoadSemesterStudents.sql" />
  			</fileset>
            <classpath>
                <fileset dir="${lib}">
                    <include name="**/*.jar"/>
                </fileset>
            </classpath>
        </sql>
    </target>


    <target name="load-2003-curricular-course-scopes"
    		depends="load-data"
            description="Carrega os Scopes de 2003 para a Tabela MW_CURRICULAR_COURSE_SCOPE">
        <sql driver="com.mysql.jdbc.Driver"
            url="jdbc:mysql://localhost/${db.name}"
            userid="${db.user}"
            password="${db.pass}"
            encoding="${encoding}">
	        <fileset dir="${sql}">
			 <include name="middleware/others/Load2003CurricularCourseScopes.sql" />
  			</fileset>
            <classpath>
                <fileset dir="${lib}">
                    <include name="**/*.jar"/>
                </fileset>
            </classpath>
        </sql>
    </target>


	<target name="create-and-update-scopes"
	        depends="compile-proj, load-2003-curricular-course-scopes">
		<java classname="middleware.curricularCourseMigration.CreateAndUpdateScopes"
			fork="yes"
			failonerror="false"
			maxmemory="512m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
	</target>

	<target name="distribute-student-by-class"
	        depends="compile-proj, load-data">
		<java classname="middleware.studentMigration.DistributeStudentsByClass"
			fork="yes"
			failonerror="false"
			maxmemory="512m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
	</target>



	<target name="clean-persons-with-duplicate-id"
	        depends="compile-proj">
	        
	    <exec executable="${sql}/middleware/commands/cleanPersonsWithDuplicateID.sh"
	  	      os="Linux, Unix">
		  <arg value="stop"/>
	  	</exec>
	  	<exec executable="${sql}/middleware/commands/cleanPersonsWithDuplicateID.bat"
	  	      vmlauncher="true"
	  	      os="Windows, Windows 2000, Windows XP">
	  	</exec>
	</target>


	<!-- ***************** ADDED BY TANIA POUSAO ***************** -->
	<target name="migrate-evaluation-elements">
		<java classname="middleware.curriculum.migrationEvaluationElements" fork="yes" failonerror="false" maxmemory="512m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>	
	
	<!-- ********************************************************* -->


	<!-- ********************** DATABASE CLEANING RELATED ********************** -->
	<target name="create-branch-codes-and-acronyms" depends="compile-proj">
		<java classname="middleware.databaseClean.branches.CreateBranchCodesAndAcronyms" fork="yes" failonerror="false" maxmemory="512m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="change-relation-between-CCScope-and-CC-of-mathAnalysisA" depends="compile-proj">
		<java classname="middleware.databaseClean.curricularCourseScopes.ChangeRelationBetweenCCScopeAndCCOfMathAnalysisA.java" fork="yes" failonerror="false" maxmemory="512m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="delete-alterative-curricularCourseScopes" depends="compile-proj">
		<java classname="middleware.databaseClean.curricularCourseScopes.DeleteAlterativeCurricularCourseScopes.java" fork="yes" failonerror="false" maxmemory="512m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="update-enrollmentEvaluations-dates-for-all-students-past-enrolments" depends="compile-proj">
		<java classname="middleware.studentMigration.enrollments.UpdateEnrollmentEvaluationsDatesForAllStudentsPastEnrolments" fork="yes" failonerror="false" maxmemory="512m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>
	<!-- *********************************************************************** -->

	<!-- ************************************************************************************************************************ -->
	<target name="credits-initialize" depends="compile-proj" description="inicializa a base de dados ao nível da tabela creditos para o semestre currente">
		<java classname="middleware.credits.CreditsInitializer" fork="yes" failonerror="false" maxmemory="512m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="fix-curriculum" depends="compile-proj" description="cixes the curricular course information">
		<java classname="middleware.degreeCurricularPlan.FixCurriculum" fork="yes" failonerror="false" maxmemory="512m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>
	
	<target name="erasmus" depends="compile-proj" description="migrates erasmus students">
		<java classname="middleware.erasmus.CreatePerson" fork="yes" failonerror="false" maxmemory="512m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="math" depends="compile-proj" description="migrates math responsibles">
		<java classname="middleware.mathResponsibles.UpdateMathResponsibles" fork="yes" failonerror="false" maxmemory="512m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

<!-- <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< -->

	<target name="run-stats-for-GEP" depends="compile-proj">
		<java classname="Tools.GEPDataGenerator" fork="yes" failonerror="false" maxmemory="896m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
			<arg line="GEP.txt"/>
		</java>
	</target>

	<target name="run-data-generator-for-almeida" depends="compile-proj">
		<java classname="Tools.AlmeidaDataGenerator" fork="yes" failonerror="false" maxmemory="896m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
			<arg line="alunos_lecc_2003_2.txt 500 false true"/>
		</java>
	</target>

<!-- <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< -->

</project>