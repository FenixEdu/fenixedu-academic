<?xml version="1.0" encoding="ISO-8859-1"?>
<project basedir="." default="MigrateData" name="CIAPL">

	<property name="sshtools.home" location="lib" />

    <property environment="env"/>

	<property file="build.properties"/>

    <!--Directorios com codigo fonte-->
    <property name="src" location="src" /> 
    <property name="src.tests" location="src_tests" /> 
    <property name="src.jsp" location="jsp" />
    <property name="metadata" location="metadata" />
    <property name="javadoc.source.home" location="javaDocSource" />
    <property name="javadoc.test.home" location="javaDocTests" />
    
	<property name="build.home" location="build"/>

    <!--Directorios destino da compilacao do projecto-->
    <property name="tests.classes" location="${build.home}/tests"/>
	<property name="webapp"          location="${build.home}/app"/>
    <property name="webapp.metadata" value="${webapp}/WEB-INF"/>
    <property name="webapp.classes"  value="${webapp.metadata}/classes"/>
    <property name="webapp.lib"      value="${webapp.metadata}/lib"/>    

    
	<!-- Directorys for deploy -->
	<property name="deploy.home" location="deploy"/>	
    <property name="deploy.jars"     value="${deploy.home}/jars"/>
	
    <!--Directorio com bibliotecas (JAR) a utilizar-->
    <property name="lib" location="lib" />
	<property location="lib_web" name="libs.web"/>

    <!--Directorio com configuracoes-->
    <property location="config" name="config"/>

    <!--Directorio com instrucoes SQL-->
    <property location="etc" name="sql"/>

    <!--Directorio com reports dos unit tests -->
    <property location="report" name="reports.tests"/>

    <!-- INTERFACE WEB -->
    <!--Directorios da aplicacao Web-->

  
	<!-- Compilation options -->
	<property name="compile.debug"       value="on"/>
  	<property name="compile.deprecation" value="on"/>
  	<property name="compile.optimize"    value="on"/>

	<property name="encoding" value="ISO-8859-15"/>	



  <target name="prepare">
    <!-- Create build directories as needed -->
	<mkdir dir="${tests.classes}"/>
	<mkdir dir="${webapp.classes}"/>	
	<mkdir dir="${webapp.lib}"/>	
	<mkdir dir="${deploy.home}"/>
    <!-- Copy external dependencies as required -->
    <!-- *** CUSTOMIZE HERE AS REQUIRED BY YOUR APPLICATION *** -->
    <copy todir="${webapp}">
    	<fileset dir="${basedir}/jsp"/>
    </copy>
    
    <copy todir="${webapp.metadata}">
    	<fileset dir="${basedir}/metadata"/>    
    </copy>

    <copy todir="${webapp.lib}">
    	<fileset dir="${basedir}/lib">    
    	      <exclude name="servlet.jar"/>
              <exclude name="strutstest.jar"/>
    	</fileset>
    	<fileset dir="${basedir}/lib_web">    
    	      <exclude name="servlet.jar"/>
              <exclude name="strutstest.jar"/>
    	</fileset>
    </copy>

	<copy todir="${webapp.classes}">
		<fileset dir="${basedir}/config"/>
	</copy>
    <!-- Copy static files from external dependencies as needed -->
    <!-- *** CUSTOMIZE HERE AS REQUIRED BY YOUR APPLICATION *** -->

  </target>
  
    <target name="compile-proj"
            description="Compila o projecto principal" depends="prepare">
        <tstamp />
        <javac destdir="${webapp.classes}"
               extdirs="${lib};${libs.web}"
               debug="${compile.debug}"
               optimize="${compile.optimize}"
               deprecation="${compile.deprecation}"
               encoding="${encoding}">
			<src path="${src}"/>
        </javac>
		<replace 
	    	dir="${webapp.metadata}"
	    	propertyFile="build.properties">
	    	<include name="**/**/*.xml"/>
	    	<include name="**/**/ApplicationResources.properties"/>
	    	<include name="**/ServidorPersistenteConfig.properties"/>
	    	<include name="**/ServidorPersistenteOracleConfig.properties"/>
		  <replacefilter 
		    token="&lt;!-- @validation.doctype@ -->" property="validation.doctype"/>
		  <replacefilter 
		    token="@login.page@" 
		    property="login.page"/>
		  
		  <replacefilter 
		    token="@db.user@" 
		    property="db.user"/>
		  <replacefilter 
		    token="@db.pass@" 
		    property="db.pass"/>
		  <replacefilter 
		    token="@db.name@" 
		    property="db.name"/>
		  <replacefilter 
		    token="@db.alias@" 
		    property="db.alias"/>
		    		    
		  <replacefilter 
		    token="@application@" 
		    property="application"/>
		</replace>
    </target>


	<!-- Database targets -->
    <target name="prepare-tables"
            description="Alter existing tables to match new structure.">
        <sql
            driver="com.mysql.jdbc.Driver"
            url="jdbc:mysql://localhost/${db.name}"
            userid="${db.user}"
            password="${db.pass}"
            encoding="${encoding}">
	        <fileset dir="${sql}">
			 <include name="migrationNextSemester/runMeBeforeDataMigration.sql" />
  			</fileset>
            <classpath>
                <fileset dir="${lib}">
                    <include name="**/*.jar"/>
                </fileset>
            </classpath>
        </sql>
    </target>
   	
	<target name="MigrateData"
	        depends="compile-proj"
	        description="Imports data from external data sources"
	>
	<!-- Download data files -->
	
	<!-- Parse data files -->
	<!-- Migrate data -->
        <java classname="middleware.thor.LoadRamos"
			fork="yes"
			failonerror="true"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
        <java classname="middleware.thor.LoadNomeDisciplinas"
			fork="yes"
			failonerror="true"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>

        <java classname="middleware.thor.LoadDisciplinas"
			fork="yes"
			failonerror="true"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
        <java classname="middleware.thor.LoadExecutionCoursesAndAssociations"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>

	<!-- Restart tomcat -->
	
   	</target>   	

	<target name="MigrateDataFromTablesToFenix"
	        depends="compile-proj"
	        description="Migrates data from Temporarily tables to FENIX"
	>
		<java classname="middleware.almeida.dcsrjao.LoadCurramToFenix"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
		<java classname="middleware.almeida.dcsrjao.LoadEscolasToFenix"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
       <java classname="middleware.almeida.dcsrjao.LoadCurricularCoursesToFenix"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
		
        <java classname="middleware.almeida.dcsrjao.LoadEnrolmentsToFenix"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>

<!-- ************************************************************************************************* 
		O maxmemory TEM de ser OBRIGATORIAMENTE 521m ou mais, 
		caso contrario a migração rebenta por falta de Memoria
 ************************************************************************************************* -->
		<java classname="middleware.almeida.dcsrjao.CreateEnrolmentEquivalences"
			fork="yes"
			failonerror="false"
			maxmemory="512m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
<!-- ************************************************************************************************* 
		isto é para sair, serve apenas enquanto se testa a aplicação com os dados migrados
 ************************************************************************************************* -->
		<java classname="middleware.almeida.dcsrjao.CreatetExecutionCoursesForLEQCurricularCourses"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
	</target>   	

	<target name="MigrateAlmeidaDataToTables"
	        depends="compile-proj"
	        description="Migrates data from Almeida files to Temporaryly Tables"
	>
		<java classname="middleware.almeida.dcsrjao.LoadAlmeidaCurricularCoursesCodesFromFileToTable"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
        <java classname="middleware.almeida.dcsrjao.LoadAlmeidaCurricularCoursesFromFileToTable"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
<!--        <java classname="middleware.almeida.dcsrjao.LoadAlmeidaCurramFromFileToTable"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
		<java classname="middleware.almeida.dcsrjao.LoadAlmeidaEscolasFromFileToTable"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
        <java classname="middleware.almeida.dcsrjao.LoadAlmeidaEnrolmentsFromFileToTable"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
-->
   	</target>   	
	<target name="MigrateAllEnrolmentData"
	        depends="compile-proj"
	        description="Migrates data from Almeida files to FENIX"
	> 	
		<java classname="middleware.almeida.dcsrjao.LoadAlmeidaCurricularCoursesCodesFromFileToTable"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
        <java classname="middleware.almeida.dcsrjao.LoadAlmeidaCurricularCoursesFromFileToTable"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
        <java classname="middleware.almeida.dcsrjao.LoadAlmeidaCurramFromFileToTable"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
		<java classname="middleware.almeida.dcsrjao.LoadAlmeidaEscolasFromFileToTable"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
        <java classname="middleware.almeida.dcsrjao.LoadAlmeidaEnrolmentsFromFileToTable"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
		<java classname="middleware.almeida.dcsrjao.LoadCurramToFenix"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
		<java classname="middleware.almeida.dcsrjao.LoadEscolasToFenix"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
       <java classname="middleware.almeida.dcsrjao.LoadCurricularCoursesToFenix"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
        <java classname="middleware.almeida.dcsrjao.LoadEnrolmentsToFenix"
			fork="yes"
			failonerror="false"
			maxmemory="512m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
        <java classname="middleware.almeida.dcsrjao.LoadCurricularCoursesEquivalencesFromFileToTable"
			fork="yes"
			failonerror="false"
			maxmemory="512m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>

<!-- ************************************************************************************************* 
		O maxmemory TEM de ser OBRIGATORIAMENTE 521m ou mais, 
		caso contrario a migração rebenta por falta de Memoria
 ************************************************************************************************* -->
		<java classname="middleware.almeida.dcsrjao.CreateEnrolmentEquivalences"
			fork="yes"
			failonerror="false"
			maxmemory="512m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
<!-- ************************************************************************************************* 
		isto é para sair, serve apenas enquanto se testa a aplicação com os dados migrados
 ************************************************************************************************* -->
	<java classname="middleware.almeida.dcsrjao.CreatetExecutionCoursesForLEQCurricularCourses"
			fork="yes"
			failonerror="false"
			maxmemory="128m"
		>
	    	<classpath>
	        	<pathelement path="${webapp.classes}"/>
	            <pathelement path="${config}"/>
	            <pathelement path="${sql}"/>
	            <pathelement path="${src}"/>
	            <fileset dir="${webapp.lib}">
	                <include name="**/*.jar"/>
	            </fileset>
	        </classpath>
		</java>
	</target>   	
</project>
