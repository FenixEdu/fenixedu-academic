#!/bin/bash
# -----------------------------------------------------------------------------
#
#   Runs sql scripts to update database from previous release.
#
# -----------------------------------------------------------------------------
#

DB=$1
USER=$2

echo Using database: $DB
echo Enter password for $USER:
read -s password

function execute() {
	echo ---------------------------------------- $1
	mysql -u$USER -f -p$password --default-character-set=latin1 $DB < $2
	echo
}

function executeWithTempFile() {
	echo ---------------------------------------- $1
	mysql -u$USER -f -p$password --default-character-set=latin1 $DB < $2 > tmp.sql
	mysql -u$USER -f -p$password --default-character-set=latin1 $DB < tmp.sql	
	rm tmp.sql
	echo
}

execute "Create table for Content and Node" createContentAndNodeTable.sql

execute "Update sql structure for and migrate data." updates.sql

execute "Preparing Forums" prepareForum.sql
execute "Prepare ConversionThread" prepareConversationThread.sql
execute "Prepare ConversationMessage" prepareConversationMessage.sql

execute "Prepare Contents" prepareContents.sql
execute "Prepare Node" prepareNode.sql
execute "Migrate Foruns" migrateForuns.sql

execute "Migrate functionalities to Content table" mergeFunctionalityInContent.sql
execute "Create functionality parameter table" createFunctionalityParameter.sql
execute "Create root module" connectRootModule.sql

execute "Create portal" createPortal.sql
execute "Create root portal" connectRootPortal.sql

execute "Prepare Contents for items and sections" prepareContentsForItemsAndSections.sql
execute "Migrate sites" migrateSites.sql 
execute "Migrate sections and items" migrateSectionsAndItems.sql

execute "Move TempSections to Sections" moveTempSectionsToSections.sql
execute "Prepare portals" preparePortals.sql

execute "Copy Module Structure" copyModuleStructure.sql

execute "Create table for MetaDomainObject" metaDomainObject.sql
execute "Adding meta domain objects for all defined types" addMetaDomainObject3.sql

execute "Update missing information in site" updateMissingInformationInSites.sql
execute "Create MetaDomainObjhect From Site Templates" createMetaDomainObjectsFromSiteTemplates.sql

execute "Update Roles" updateRole.sql
execute "Migrate Top Sections, esta esqueci-me depois aquando merge pode-se juntar com o migrateSectionsAndItems" migrateTopSections.sql

execute "Create execution path for functionalities" createExecutionPathTable.sql
execute "Criar chave da Pool, este scripts pode depois ser merged na criação da tabela meta domain object" createKeysForPool.sql
execute "Associar os conteúdos às pools. Com algum cuidado tb deverá ser merged na criação da tabela meta domain object" createPools.sql

#execute "Initilize portal stuff from modules." initPortals.sql
execute "Associate Templates to Root Module" connectTemplatesToRoot.sql

execute "Add content ID to EVERYTHING!!!" addContentId.sql

execute "Add Attachment" addAttachment.sql 
execute "Connect ExecutionCourseForum to ExecutionCourseSite"  connectExecutionCourseForumToExecutionCourseSite.sql
