DROP TABLE IF EXISTS XPTO;
CREATE TABLE XPTO SELECT * FROM ENROLMENT_EVALUATION WHERE GRADE IS NOT NULL GROUP BY KEY_ENROLMENT HAVING COUNT(*) = 1;

DROP TABLE IF EXISTS XPTI;
CREATE TABLE XPTI SELECT * FROM XPTO WHERE GRADE = 'RE';

DROP TABLE IF EXISTS XPTE;
CREATE TABLE XPTE SELECT E.* FROM ENROLMENT E
INNER JOIN XPTI X ON X.KEY_ENROLMENT = E.ID_INTERNAL
WHERE E.STATE <> 2 AND E.STATE <> 5;

SELECT CONCAT('UPDATE ENROLMENT SET STATE = 2 WHERE ID_INTERNAL = ', X.ID_INTERNAL, ';') AS "" FROM XPTE X;


DROP TABLE IF EXISTS XPTI;
CREATE TABLE XPTI SELECT * FROM XPTO WHERE GRADE = 'NA';

DROP TABLE IF EXISTS XPTE;
CREATE TABLE XPTE SELECT E.* FROM ENROLMENT E
INNER JOIN XPTI X ON X.KEY_ENROLMENT = E.ID_INTERNAL
WHERE E.STATE <> 6 AND E.STATE <> 5;

SELECT CONCAT('UPDATE ENROLMENT SET STATE = 6 WHERE ID_INTERNAL = ', X.ID_INTERNAL, ';') AS "" FROM XPTE X;


DROP TABLE IF EXISTS XPTI;
CREATE TABLE XPTI SELECT * FROM XPTO WHERE GRADE IS NULL;

DROP TABLE IF EXISTS XPTE;
CREATE TABLE XPTE SELECT E.* FROM ENROLMENT E
INNER JOIN XPTI X ON X.KEY_ENROLMENT = E.ID_INTERNAL
WHERE E.STATE <> 3 AND E.STATE <> 5;

SELECT CONCAT('UPDATE ENROLMENT SET STATE = 3 WHERE ID_INTERNAL = ', X.ID_INTERNAL, ';') AS "" FROM XPTE X;


DROP TABLE IF EXISTS XPTI;
CREATE TABLE XPTI SELECT * FROM XPTO WHERE GRADE <> 'NA' AND GRADE <> 'RE' AND GRADE IS NOT NULL;

DROP TABLE IF EXISTS XPTE;
CREATE TABLE XPTE SELECT E.* FROM ENROLMENT E
INNER JOIN XPTI X ON X.KEY_ENROLMENT = E.ID_INTERNAL
WHERE E.STATE <> 1 AND E.STATE <> 5;

SELECT CONCAT('UPDATE ENROLMENT SET STATE = 1 WHERE ID_INTERNAL = ', X.ID_INTERNAL, ';') AS "" FROM XPTE X;


DROP TABLE IF EXISTS XPTO;
DROP TABLE IF EXISTS XPTI;
DROP TABLE IF EXISTS XPTE;

-- ******************************************************************************************************

SELECT CONCAT('UPDATE ENROLMENT_EVALUATION SET STATE = 1 WHERE ID_INTERNAL = ', ID_INTERNAL, ';') AS ""
FROM ENROLMENT_EVALUATION EV, ENROLMENT E, STUDENT_CURRICULAR_PLAN SCP, DEGREE_CURRICULAR_PLAN DCP, DEGREE D
WHERE EV.KEY_ENROLMENT=E.ID_INTERNAL
AND E.KEY_STUDENT_CURRICULAR_PLAN=SCP.ID_INTERNAL
AND SCP.KEY_DEGREE_CURRICULAR_PLAN=DCP.ID_INTERNAL
AND DCP.KEY_DEGREE=D.ID_INTERNAL
AND D.TYPE_DEGREE=1
AND GRADE IS NOT NULL AND STATE = 2;

-- ******************************************************************************************************

DROP TABLE IF EXISTS XPTO;
CREATE TABLE XPTO
SELECT EE1.* FROM ENROLMENT_EVALUATION EE1
INNER JOIN ENROLMENT_EVALUATION EE2 ON
EE1.KEY_ENROLMENT = EE2.KEY_ENROLMENT
WHERE
EE1.GRADE IS NULL AND
EE2.GRADE IS NULL AND
EE1.ID_INTERNAL <> EE2.ID_INTERNAL;


DROP TABLE IF EXISTS XPTI;
CREATE TABLE XPTI
SELECT * FROM ENROLMENT_EVALUATION WHERE GRADE IS NULL GROUP BY KEY_ENROLMENT HAVING COUNT(*) > 1;


SELECT CONCAT('DELETE FROM ENROLMENT_EVALUATION WHERE ID_INTERNAL = ', EE.ID_INTERNAL, ';') AS ""
FROM ENROLMENT_EVALUATION EE
INNER JOIN XPTO X ON X.ID_INTERNAL = EE.ID_INTERNAL
INNER JOIN ENROLMENT E ON EE.KEY_ENROLMENT = E.ID_INTERNAL
WHERE E.KEY_EXECUTION_PERIOD = 80;


SELECT CONCAT('INSERT INTO ENROLMENT_EVALUATION VALUES (NULL, NULL, 1, NULL, NULL, NULL, 2, ', KEY_ENROLMENT, ', NULL, NULL, NULL, NULL, 1);') AS ""
FROM XPTI;

-- ******************************************************************************************************

