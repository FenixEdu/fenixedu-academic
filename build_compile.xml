<?xml version="1.0" encoding="ISO-8859-1"?>
<project basedir="." default="compile" name="Compilation Scripts">

	<property environment="env"/>
	<property name="encoding" value="ISO-8859-1"/>

	<property file="build.properties"/>

	<!-- Source code directories -->
	<property name="src" location="src"/>
	<property name="src_gen" location="src_gen"/>
	<property name="config" location="config"/>
	<property name="institution.config" location="${institution.project}/config"/>
	<property name="config.web" location="metadata"/>

	<!-- Directories for compiled code -->
	<property name="build.home" location="build"/>
	<property name="build.home.webinf" value="${build.home}/WEB-INF"/>
	<property name="build.home.webinf.classes" value="${build.home.webinf}/classes"/>
	<property name="build.home.webinf.conf" value="${build.home.webinf}/conf"/>
	<property name="build.home.webinf.libs" value="${build.home.webinf}/lib"/>
	<property name="build.home.jsp_gen_code" value="${build.home}/Jsp-Code"/>
	<property name="build.home.jsp_gen_code.classes" value="${build.home.jsp_gen_code}/classes"/>

	<!-- Directories for deploy -->
	<property name="deploy.home" location="deploy"/>

	<!-- Directories with libraries (JARs) -->
	<property name="lib" location="lib" />

	<!-- Directory with SQL instructions -->
	<property name="etc" location="etc"/>

	<!-- Directory with web-content -->
	<property name="web-content" location="jsp"/>
	<property name="institution.web-content" location="${institution.project}/jsp"/>

	<!-- DML definition file -->
	<property name="dml.definition.file" value="${config}/domain_model.dml"/>
	<property name="dml.definition.file.completed" value="${build.home.webinf.classes}/domain_model.dml"/>

	<!-- Compilation options -->
	<property name="compile.debug"       value="on"/>
	<property name="compile.deprecation" value="off"/>
	<property name="compile.optimize"    value="on"/>

	<!-- Renderers properties -->
	<property name="renderers.package.dir" value="net/sourceforge/fenixedu/renderers"/>
	<property name="renderers.lib.name" value="fenix-renderers.jar"/>

	<target name="clean-all"
    		description="Removes any generated files">
		<delete dir="${build.home}"/>
		<delete dir="${deploy.home}"/>
	</target>

	<target name="prepare"
			description="Copy configuration files to compile dir">
		<mkdir dir="${build.home}"/>
		<mkdir dir="${build.home.webinf}"/>
		<mkdir dir="${build.home.webinf.classes}"/>
		<mkdir dir="${build.home.webinf.libs}"/>
		<mkdir dir="${build.home}/images/logs"/>

		<sequential>
			<delete file="${build.home.webinf.libs}/dml.jar"/>

			<copy todir="${build.home}">
				<fileset dir="${web-content}" >
					<include name="**/*.*"/>
					<exclude name="WEB-INF//*.*"/>
				</fileset>
			</copy>

			<copy todir="${build.home.webinf.classes}">
				<fileset dir="${config}"/>
			</copy>

			<copy todir="${build.home.webinf}">
				<fileset dir="${config.web}" >
					<include name="**/*.*"/>
				</fileset>
			</copy>

			<copy todir="${build.home.webinf.libs}">
				<fileset dir="${lib}" >
					<include name="*.jar"/>
				</fileset>
			</copy>

			<antcall target="prepare-institution"/>

			<!-- Replace tokens in configuration files with local config -->
			<antcall target="replace-property-values"/>
		</sequential>

		<echo file="${build.home.webinf.classes}/checkIsAlive.properties" append="false">
script.isAlive.check.db=${script.isAlive.check.db}
script.isAlive.check.slide=${script.isAlive.check.slide}
		</echo>
	</target>

	<target name="prepare-institution" if="institution.project">
		<copy todir="${build.home}">
			<fileset dir="${institution.web-content}" >
				<include name="**/*.*"/>
				<exclude name="WEB-INF//*.*"/>
			</fileset>
		</copy>

		<copy todir="${build.home.webinf.classes}">
			<fileset dir="${institution.config}"/>
		</copy>
	</target>

	<target name="replace-property-values">

		<parallel>
			<replace dir="${build.home.webinf.classes}/OJB/"
					 propertyFile="build.properties">
				<include name="repository_database.xml"/>
				<replacefilter token="@db.user@"
							   property="db.user"/>
				<replacefilter token="@db.pass@" 
							   property="db.pass"/>
				<replacefilter token="@db.name@"
							   property="db.name"/>
				<replacefilter token="@db.alias@"
							   property="db.alias"/>

				<replacefilter token="@db.assiduousness.user@"
								   property="db.assiduousness.user"/>
				<replacefilter token="@db.assiduousness.pass@" 
				    			   property="db.assiduousness.pass"/>
				<replacefilter token="@db.assiduousness.name@" 
								   property="db.assiduousness.name"/>
				<replacefilter token="@db.assiduousness.alias@" 
				    			   property="db.assiduousness.alias"/>
				<replacefilter token="@db.assiduousness.platform@" 
				    			   property="db.assiduousness.platform"/>
				<replacefilter token="@db.assiduousness.driver@" 
				    			   property="db.assiduousness.driver"/>
				<replacefilter token="@db.assiduousness.protocol@" 
				    			   property="db.assiduousness.protocol"/>
				<replacefilter token="@db.assiduousness.subprotocol@" 
				    			   property="db.assiduousness.subprotocol"/>
				<replacefilter token="@db.assiduousness.validationQuery@" 
				    			   property="db.assiduousness.validationQuery"/>

				<replacefilter token="@db.personFilter.user@" 
				    			   property="db.personFilter.user"/>
				<replacefilter token="@db.personFilter.pass@" 
				    			   property="db.personFilter.pass"/>
				<replacefilter token="@db.personFilter.name@" 
				    			   property="db.personFilter.name"/>
				<replacefilter token="@db.personFilter.alias@" 
				    			   property="db.personFilter.alias"/>
				<replacefilter token="@db.personFilter.platform@" 
				    			   property="db.personFilter.platform"/>
				<replacefilter token="@db.personFilter.driver@" 
				    			   property="db.personFilter.driver"/>
				<replacefilter token="@db.personFilter.protocol@" 
				    			   property="db.personFilter.protocol"/>
				<replacefilter token="@db.personFilter.subprotocol@" 
				    			   property="db.personFilter.subprotocol"/>
				<replacefilter token="@db.personFilter.validationQuery@" 
				    			   property="db.personFilter.validationQuery"/>
				<replacefilter token="@db.personFilter.other@" 
				    			   property="db.personFilter.other"/>
				<replacefilter token="@db.personFilter.errorFile@" 
				    			   property="db.personFilter.errorFile"/>
				<replacefilter token="@db.personFilter.log@" 
				    			   property="db.personFilter.log"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="Domain.xml"/>
				<replacefilter token="@db.slide.driver@" 
			    			   property="db.slide.driver"/>
				<replacefilter token="@db.slide.alias@" 
			    			   property="db.slide.alias"/>
				<replacefilter token="@db.slide.user@" 
			    			   property="db.slide.user"/>
				<replacefilter token="@db.slide.pass@" 
			    			   property="db.slide.pass"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="cms.properties"/>
				<replacefilter token="@cms.mailer.username@" 
			    			   property="cms.mailer.username"/>
				<replacefilter token="@cms.mailer.password@" 
			    			   property="cms.mailer.password"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="SMTPConfiguration.properties"/>
				<replacefilter token="@mail.smtp.host@" 
			    			   property="mail.smtp.host"/>
				<replacefilter token="@mail.smtp.name@" 
			    			   property="mail.smtp.name"/>
			</replace>



			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="slide.properties"/>
				<replacefilter token="@slide.config@" 
			    			   property="slide.config"/>
				<replacefilter token="@db.slide.driver@" 
			    			   property="db.slide.driver"/>
				<replacefilter token="@db.slide.alias@" 
			    			   property="db.slide.alias"/>
				<replacefilter token="@db.slide.user@" 
			    			   property="db.slide.user"/>
				<replacefilter token="@db.slide.pass@" 
			    			   property="db.slide.pass"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="IstFtpServerConfig.properties"/>
				<replacefilter 
		                 token="@ftp.IST.server.user@" 
		                 property="ftp.IST.server.user"/>
				<replacefilter 
	                  token="@ftp.IST.server.pass@" 
	                  property="ftp.IST.server.pass"/>
				<replacefilter 
	                 token="@ftp.IST.server.address@" 
	                 property="ftp.IST.server.address"/>
				<replacefilter 
	                 token="@ftp.IST.scp.command@" 
	                 property="ftp.IST.scp.command"/>
				<replacefilter 
	                 token="@ftp.IST.scp.args@" 
	                 property="ftp.IST.scp.args"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="DegreeGradesFtpServerConfig.properties"/>
				<replacefilter 
    	             token="@ftp.degree.grades.server.user@" 
	                 property="ftp.degree.grades.server.user"/>
				<replacefilter 
	                  token="@ftp.degree.grades.server.pass@" 
	                  property="ftp.degree.grades.server.pass"/>
				<replacefilter 
	                 token="@ftp.degree.grades.server.address@" 
	                 property="ftp.degree.grades.server.address"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="logAnalyser.properties"/>
				<include name="log4j.xml"/>
				<replacefilter token="@log.image.directory@"
			  				   property="log.image.directory"/>
				<replacefilter token="@log.profile.dir@"
			  				   property="log.profile.dir"/>
				<replacefilter token="@log.profile.filename@"
			  				   property="log.profile.filename"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="OJB.properties"/>
				<replacefilter token="@ObjectCacheClass@"
			    			   property="ObjectCacheClass"/>
				<replacefilter token="@JdbcAccessClass@"
			    			   property="JdbcAccessClass"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="oscache.properties"/>
				<replacefilter token="@cache.event.listeners@"
			    			   property="cache.event.listeners"/>
				<replacefilter token="@cache.cluster.multicast.ip@"
			    			   property="cache.cluster.multicast.ip"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="SMSConfiguration.properties"/>
				<replacefilter token="@sms.gateway.host@"
			    			   property="sms.gateway.host"/>
				<replacefilter token="@sms.gateway.port@"
			    			   property="sms.gateway.port"/>
				<replacefilter token="@sms.gateway.uri@"
			    			   property="sms.gateway.uri"/>
				<replacefilter token="@sms.gateway.protocol@"
			    			   property="sms.gateway.protocol"/>
				<replacefilter token="@sms.gateway.username@"
			    			   property="sms.gateway.username"/>
				<replacefilter token="@sms.gateway.password@"
			    			   property="sms.gateway.password"/>
				<replacefilter token="@sms.delivery.host@"
			    			   property="sms.delivery.host"/>
				<replacefilter token="@sms.delivery.port@"
			    			   property="sms.delivery.port"/>
				<replacefilter token="@sms.delivery.uri@"
			    			   property="sms.delivery.uri"/>
				<replacefilter token="@sms.delivery.protocol@"
			    			   property="sms.delivery.protocol"/>
				<replacefilter token="@sms.delivery.username@"
			    			   property="sms.delivery.username"/>
				<replacefilter token="@sms.delivery.password@"
			    			   property="sms.delivery.password"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="GratuitySituationCreatorTask.properties"/>
				<replacefilter token="@gratuity.situation.creator.task.hour@"
		    			   property="gratuity.situation.creator.task.hour"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="configuration.properties"/>
				<replacefilter token="@app.name@"
		    			   property="app.name"/>
				<replacefilter 
				    token="@app.context@"
				    property="app.context"/>
				<replacefilter token="@login.page@"
							   value="${login.page}"/>
				<replacefilter token="@roleback.filename@"
		    			   property="roleback.filename"/>
				<replacefilter token="@default.persistenceSupport@"
		    			   property="default.persistenceSupport"/>
				<replacefilter token="@cas.enabled@"
			  				   property="cas.enabled"/>
				<replacefilter token="@cas.loginUrl@"
			  				   property="cas.loginUrl"/>
				<replacefilter token="@cas.validateUrl@"
			  				   property="cas.validateUrl"/>
				<replacefilter token="@cas.logoutUrl@"
			  				   property="cas.logoutUrl"/>
				<replacefilter token="@password.generator@"
		    			   property="password.generator"/>	
				<replacefilter token="@checkPasswordKerberos.authorizedHosts@"
							property="checkPasswordKerberos.authorizedHosts"/>
				<replacefilter token="@language@"
						    property="language"/>	
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="log4j.xml"/>
				<replacefilter token="@log4j.email.smtp.host@"
							   property="log4j.email.smtp.host"/>
				<replacefilter token="@log4j.email.smtp.from@"
							   property="log4j.email.smtp.from"/>
				<replacefilter token="@log4j.email.smtp.to@"
							   property="log4j.email.smtp.to"/>
				<replacefilter token="@log4j.email.smtp.subject@"
							   property="log4j.email.smtp.subject"/>
				<replacefilter token="@log.image.directory@"
			  				   property="log.image.directory"/>
				<replacefilter token="@log.profile.dir@"
			  				   property="log.profile.dir"/>
				<replacefilter token="@log.profile.filename@"
			  				   property="log.profile.filename"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="projectsManagement.properties"/>
				<replacefilter token="@db.projectManagement.user@"
							   property="db.projectManagement.user"/>
				<replacefilter token="@db.projectManagement.pass@"
							   property="db.projectManagement.pass"/>
				<replacefilter token="@db.projectManagement.alias@"
							   property="db.projectManagement.alias"/>
			</replace>

			<replace dir="${build.home.webinf.classes}/resources"
					 propertyFile="build.properties">
				<include name="ApplicationResources*.properties"/>
				<include name="ApplicationResourcesSOP*.properties"/>
				<include name="ManagerResources*.properties"/>
				<replacefilter token="@login.page@"
							   value="${login.page}"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="logAnalyser.properties"/>
				<replacefilter token="@login.page@"
					  		   value="${login.page}"/>
				<replacefilter token="@log.image.directory@"
			  				   property="log.image.directory"/>
				<replacefilter token="@log.profile.dir@"
			  				   property="log.profile.dir"/>
				<replacefilter token="@log.profile.filename@"
			  				   property="log.profile.filename"/>
			</replace>

			<replace dir="${build.home.webinf}"
					 propertyFile="build.properties">
				<include name="web.xml"/>
				<replacefilter 
				    token="@app.context@"
				    property="app.context"/>
				<replacefilter 
				    token="@manager.filter.pattern@"
				    property="manager.filter.pattern"/>
			</replace>

			<replace dir="${build.home.webinf}/conf" propertyFile="build.properties">
				<include name="validation*.xml"/>
				<replacefilter 
				    token="@validation.doctype.url@" 
				    property="struts.validation.doctype.url"/>
			</replace>

			<replace dir="${build.home}"
					 propertyFile="build.properties">
				<include name="publico/index.html"/>
				<include name="publico/degreeSite/mainNavigation_without_teaching.jsp"/>
				<replacefilter 
					    token="@institution.url@" 
					    property="institution.url"/>
			</replace>

			<replace dir="${build.home}"
					 propertyFile="build.properties">
				<include name="student/enrollment/warning.jsp"/>
				<include name="degreeAdministrativeOffice/enrolment/withRules/enrollmentConfirmation.jsp"/>
				<include name="degreeAdministrativeOffice/enrolment/withRules/prepareEnrollmentChooseCurricularCourses.jsp"/>
				<replacefilter token="@enrollment.faq.url@"
			    			   property="enrollment.faq.url"/>
			</replace>
			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="services.xml"/>
				<replacefilter token="@authenticationService@"
			  		property="authenticationService"/>
				<replacefilter token="@changePassService@"
					property="changePassService"/>
			</replace>
			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="berserk.properties"/>
				<replacefilter token="@application.filterBroker@"
			  				   property="application.filterBroker"/>
			</replace>
		</parallel>
	</target>

    <!-- = = = = = = = = = = = = = = = = =
          macrodef: generateHostDependentProperties
          
          Generates a properties file with a definition (or key entry) for each host
          specified in the ${filter.hostnames} property.
          
          Args:
          	prefix   - the prefix for each host dependent property. This means that the property
          	           for each host will have the form ${prefix}.${hostname}
          	destfile - the name of the properties file to be generated. This file will contain
          	           one lines for each hostname with the format:
          	           
          	           ${prefix}.${hostname}=${prefix.hostname}
          	           
          	hostnames - the name of the property that contains the list of hostnames
          				default = filter.hostnames
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="generateHostDependentProperties">
        <attribute name="hostnames" default="filter.hostnames" />
        <attribute name="prefix" default="" />
        <attribute name="destfile" default="" />
    	
        <sequential>
        		<delete file="@{destfile}.xml"/>
    			<delete file="${build.home.webinf.classes}/@{destfile}"/>
    			<property name="ant.regexp.regexpimpl" value="org.apache.tools.ant.util.regexp.Jdk14RegexpRegexp"/>
    			<concat destfile="@{destfile}.xml">
    				${@{hostnames}}
    				<filterchain>
    					<tokenfilter>
    						<ignoreblank/>
    						<trim/>
    						<stringtokenizer delims="," delimsaretokens="true" includeDelims="false"/>
    						<replaceregex pattern="(.*)" replace="\1${line.seperator}"/>
    					</tokenfilter>
    					<tokenfilter>
    						<replacestring from="," to=""/>
    						<trim/>
    						<ignoreblank/>
    					</tokenfilter>
    					<prefixlines prefix="@@@{prefix}."/>
    					<prefixlines prefix="file='${build.home.webinf.classes}/@{destfile}'>"/>
    					<prefixlines prefix="append='true' "/>
    					<prefixlines prefix="${character.lessthan}echo "/>
    					<tokenfilter>
    						<stringtokenizer delims="${line.seperator}" delimsaretokens="false" includeDelims="false"/>
    						<replaceregex pattern="(.*)"
    							flags="s"
    							replace="\1@${allowed-roles.newline.instruction}${character.lessthan}/echo>"/>
    					</tokenfilter>
    					<tokenfilter>
    						<stringtokenizer delims="${line.seperator}" delimsaretokens="false" includeDelims="false"/>
    						<replaceregex pattern="@(.*)@"
    							flags="s"
    							replace="\1=${character.dollar}{\1}"/>
    					</tokenfilter>
    					<tokenfilter>
    						<stringtokenizer delims="@@@@@@" delimsaretokens="false" includeDelims="false"/>
    						<replaceregex pattern="(.*)"
    							flags="s"
    							replace="${allowed-roles.build.file.constructor.header}\1${allowed-roles.build.file.constructor.tail}"/>
    					</tokenfilter>
    					<escapeunicode/>
    				</filterchain>
    			</concat>
    			<ant antfile="@{destfile}.xml"/>
    			<delete file="@{destfile}.xml"/>
        </sequential>
    </macrodef>

	<target name="write-index-redirect-hostnames-configuration-file">
		<generateHostDependentProperties prefix="index.html.link" destfile=".indexRedirectHostnames.properties"/>
	</target>

	<target name="write-filter-hostnames-configuration-file">
		<generateHostDependentProperties prefix="filter.hostname" destfile=".authenticationServiceHostnamesFiltering.properties"/>
	</target>
	
	<target name="write-cas-serviceUrl-hostnames-configuration-file">
		<generateHostDependentProperties prefix="cas.serviceUrl" destfile=".casServiceUrlHostnames.properties"/>
	</target>
	
	<target name="write-path-access-control-configuration-file">
		<copy file="build.properties" tofile="${build.home.webinf.classes}/.hostAccessControl.properties">
			<filterchain>
				<linecontainsregexp>
					<regexp pattern="^host.control.(path|name)."/>
				</linecontainsregexp>
			</filterchain>
		</copy>
	</target>
	
	<target name="write-all-properties" 
		depends="write-filter-hostnames-configuration-file,write-index-redirect-hostnames-configuration-file,write-cas-serviceUrl-hostnames-configuration-file,write-path-access-control-configuration-file">
	</target>
	
	<target name="generate" description="Generate java code">
		<ant antfile="build_codeGenerator.xml" target="generate-domain"/>
		<ant antfile="build_codeGenerator.xml" target="update-RootDomainObject"/>
<!--
		<ant antfile="build_codeGenerator.xml" target="generate-DAOs"/>
-->
	</target>

	<target name="i18nDefault"
    		depends="prepare">
		<copy todir="${build.home.webinf.classes}/resources">
			<fileset dir="${build.home.webinf.classes}/resources" >
				<include name="*_pt.properties"/>
			</fileset>
			<globmapper from="*_pt.properties" to="*.properties"/>
		</copy>
	</target>

	<target name="compile-domain" 
          description="Compile application's domain"
          depends="generate">
		<javac destdir="${build.home.webinf.classes}"
           extdirs="${lib}"
           debug="${compile.debug}"
           optimize="${compile.optimize}"
           deprecation="${compile.deprecation}"
           encoding="${encoding}"
           nowarn="true">
			<src path="${src_gen}"/>
			<src path="${src}"/>
			<include name="net/sourceforge/fenixedu/tools/**"/>
			<include name="net/sourceforge/fenixedu/domain/**"/>
			<include name="relation/**"/>
		</javac>
		<java classname="net.sourceforge.fenixedu.tools.CreateDomainFactoryClassSource" 
          dir="${src_gen}"
          fork="true">
			<classpath>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
			<arg value="-cfn"/>
			<arg value="net.sourceforge.fenixedu.domain.DomainFactory"/>
			<arg value="-d"/>
			<arg value="${dml.definition.file.completed}"/>
		</java>
	</target>

	<target name="check-renderers" description="Checks if the lib built is still up to date">
		<uptodate property="renderers.skip-compile" targetfile="${lib}/${renderers.lib.name}">
			<srcfiles dir="${src}/${renderers.package.dir}" includes="**/*.*" />
		</uptodate>
	</target>

	<target name="print-renderers-message" if="renderers.skip-compile">
		<echo level="info">Renderers lib is up to date: '${renderers.lib.name}' not built.</echo>
	</target>

	<target name="compile-renderers" depends="check-renderers,print-renderers-message" unless="renderers.skip-compile" description="Make renderers available as a lib">
		<javac srcdir="${src}" includes="${renderers.package.dir}/**" destdir="${build.home.webinf.classes}" 
			   extdirs="${lib}" 
			   debug="${compile.debug}" 
			   optimize="${compile.optimize}" 
			   deprecation="${compile.deprecation}" 
			   encoding="${encoding}" 
			   nowarn="true" />
		
		<jar destfile="${lib}/${renderers.lib.name}" basedir="${build.home.webinf.classes}" 
			 includes="${renderers.package.dir}/**" />
		<copy file="${lib}/${renderers.lib.name}" todir="${build.home.webinf.libs}"/>

		<delete dir="${build.home.webinf.classes}/${renderers.package.dir}" />
	</target>

	<target name="base-compile" description="Compile application" depends="compile-domain,compile-renderers,i18nDefault, write-all-properties, generate">
		<javac destdir="${build.home.webinf.classes}" extdirs="${lib}" debug="${compile.debug}" optimize="${compile.optimize}" deprecation="${compile.deprecation}" encoding="${encoding}" nowarn="true">
			<src path="${src_gen}"/>
			<src path="${src}"/>

			<!-- they are used as a lib and not directly -->
			<exclude name="${renderers.package.dir}/**"/>
		</javac>
		<java classname="net.sourceforge.fenixedu.tools.AddOJBConstructors" 
			dir="${build.home.webinf.classes}"
			fork="true">
			<classpath>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
			<arg value="-cfn"/>
			<arg value="net.sourceforge.fenixedu.persistenceTier.OJB.DomainAllocator"/>
			<arg value="-d"/>
			<arg value="${dml.definition.file.completed}"/>
		</java>
	</target>

	<target name="compile" description="Compile application" depends="i18nDefault, compile-domain,compile-renderers, write-all-properties, generate, base-compile">
		<ant antfile="build_accessControl.xml"/>
	</target>

	<target name="compile-without-access-control" description="Compile application" depends="compile-domain,compile-renderers,i18nDefault, write-all-properties, generate, base-compile">
		<ant antfile="build_accessControl.xml" target="void-inject"/>
	</target>

	<target name="deploy-linux"
            description="Deploys standalone application to local web server">
		<exec executable="rm" failonerror="false" os="Linux">
			<arg line="-rf"/>
			<arg line="${env.CATALINA_HOME}/webapps/${app.context}"/>
		</exec>
		<exec executable="ln" failonerror="false" os="Linux">
			<arg line="-s"/>
			<arg line="${build.home}"/>
			<arg line="${env.CATALINA_HOME}/webapps/${app.context}"/>
		</exec>
	</target>

	<target name="deploy-win"
            description="Deploys standalone application to local web server">
		<ant antfile="build_tomcat.xml" target="install">
			<property name="webapp" value="${build.home}"/>
		</ant>
	</target>

	<target name="install-without-depends"
            description="Deploys standalone application to web server">
		<exec executable="ant.bat" failonerror="false" failifexecutionfails="false" os="Windows XP, Windows 2000, Windows 98, Windows NT, Windows 95">
			<arg line="-f"/>
			<arg line="build_compile.xml"/>
			<arg line="deploy-win"/>
		</exec>
		<exec executable="ant" failonerror="false" os="Linux">
			<arg line="-f"/>
			<arg line="build_compile.xml"/>
			<arg line="deploy-linux"/>
		</exec>
	</target>

	<target name="install"
    		depends="compile"
            description="Deploys standalone application to web server">
		<antcall target="install-without-depends"/>
	</target>

	<target name="base-jar"
            description="Generates a java archive applications 'core' (services and domain).">
		<mkdir dir="${deploy.home}"/>
		<jar destfile="${deploy.home}/${app.name}.jar">
			<fileset dir="${build.home.webinf.classes}">
				<include name="net/sourceforge/fenixedu/_development/**/*.class"/>
				<include name="net/sourceforge/fenixedu/constants/**/*.class"/>
				<include name="net/sourceforge/fenixedu/commons/**/*.class"/>
				<include name="net/sourceforge/fenixedu/dataTransferObject/**/*.class"/>
				<include name="net/sourceforge/fenixedu/domain/**/*.class"/>
				<include name="net/sourceforge/fenixedu/fileSuport/**/*.class"/>
				<include name="net/sourceforge/fenixedu/middleware/**/*.class"/>
				<include name="net/sourceforge/fenixedu/applicationTier/**/*.class"/>
				<include name="net/sourceforge/fenixedu/persistenceTier/**/*.class"/>
				<include name="net/sourceforge/fenixedu/persistenceTierFiltroPessoa/**/*.class"/>
				<include name="net/sourceforge/fenixedu/persistenceTierJDBC/**/*.class"/>
				<include name="net/sourceforge/fenixedu/persistenceTierOracle/**/*.class"/>
				<include name="net/sourceforge/fenixedu/util/**/*.class"/>
				<include name="net/sourceforge/fenixedu/utilInsc/**/*.class"/>
				<include name="net/sourceforge/fenixedu/utilTests/**/*.class"/>
				<include name="net/sourceforge/fenixedu/tools/**/*.class"/>
				<include name="net/sourceforge/fenixedu/framework/**/*.class"/>
				<include name="relations/*.class"/>
				<include name="org/**/*.class"/>
			</fileset>
		</jar>
	</target>

	<target name="jar"
    		depends="compile, base-jar"
            description="Generates a java archive applications 'core' (services and domain)."/>

	<target name="jar-without-access-control"
    		depends="compile-without-access-control, base-jar"
            description="Generates a java archive applications 'core' (services and domain), without code injection for access control"/>

	<target name="war"
	    	depends="compile"
            description="Generates a web archive of the application.">
		<mkdir dir="${deploy.home}"/>
		<war destfile="${deploy.home}/${app.name}.war" webxml="${build.home.webinf}/web.xml">
			<fileset dir="${build.home}">
				<exclude name="WEB-INF/web.xml"/>
				<exclude name="WEB-INF/classes/**"/>
				<exclude name="WEB-INF/lib/*"/>
			</fileset>
			<lib dir="${build.home.webinf.libs}"/>
			<classes dir="${build.home.webinf.classes}"/>
		</war>
	</target>

	<target name="jsp-precompile" depends="compile">
		<mkdir dir="${build.home.jsp_gen_code}"/>
		<mkdir dir="${build.home.jsp_gen_code.classes}"/>
		<taskdef classname="org.apache.jasper.JspC" name="jasper2" >
			<classpath id="jspc.classpath">
				<pathelement location="${jenv.JAVA_HOME}/../lib/tools.jar"/>
				<fileset dir="${env.CATALINA_HOME}/bin">
					<include name="*.jar"/>
				</fileset>
				<fileset dir="${env.CATALINA_HOME}/server/lib">
					<include name="*.jar"/>
				</fileset>
				<fileset dir="${env.CATALINA_HOME}/common/lib">
					<include name="*.jar"/>
				</fileset>
			</classpath>
		</taskdef>

		<jasper2 
	             validateXml="false" 
	             uriroot="${build.home}" 	            
	        	 webXmlFragment="${build.home.webinf}/generated_web.xml"
	             outputDir="${build.home.jsp_gen_code}" />

		<!--<jspc srcdir="${build.home}" destdir="${build.home.jsp_gen_code}"
				package="net.sourceforge.fenixedu.jsp" compiler="jasper2" verbose="0"  uriroot="${build.home}">
			<classpath>
				<fileset dir="${env.CATALINA_HOME}/common/lib">
					<include name="*.jar"/>
				</fileset>
			</classpath>
			<include name="**/*.jsp"/>
			;${env.CATALINA_HOME}/server/lib
			               extdirs="${lib};${build.home.webinf.classes};${env.CATALINA_HOME}/common/lib;"
		</jspc>-->

		<javac destdir="${build.home.webinf.classes}"

               debug="${compile.debug}"
               optimize="${compile.optimize}"
               deprecation="${compile.deprecation}"
			   classpath="struts.jar"
               encoding="${encoding}"
			   nowarn="true">
			<classpath>
				<pathelement path="${build.home.webinf.classes};"/>
				<fileset dir="${lib}">
					<include name="*.jar"/>
				</fileset>
				<pathelement location="${env.CATALINA_HOME}/common/classes"/>
				<fileset dir="${env.CATALINA_HOME}/common/lib">
					<include name="*.jar"/>
				</fileset>
				<pathelement location="${env.CATALINA_HOME}/shared/classes"/>
				<fileset dir="${env.CATALINA_HOME}/shared/lib">
					<include name="*.jar"/>
				</fileset>
				<fileset dir="${env.CATALINA_HOME}/bin">
					<include name="*.jar"/>
				</fileset>
			</classpath>
			<src path="${build.home.jsp_gen_code}"/>
		</javac>

	</target>

	<target name="run">
		<java classname="net.sourceforge.fenixedu.applicationTier.Servico.manager.semesterInitialization.InitializeExecutionPeriod"
				fork="true"
				failonerror="true"
				maxmemory="1024m"
				>
			<arg value="2"/>
			<arg value="2004/2005"/>

			<arg value="PY"/>
			<arg value="P5"/>
			<arg value="AC1"/>
			<arg value="AC0"/>
			<arg value="PM"/>
			<arg value="RB"/>
			<arg value="QA"/>
			<arg value="AG"/>
			<arg value="22"/>
			<arg value="RM"/>
			<arg value="QM"/>
			<arg value="QY"/>
			<arg value="PA"/>
			<arg value="AZ3"/>
			<arg value="AH"/>
			<arg value="26"/>
			<arg value="RS"/>
			<arg value="QS"/>
			<arg value="PG"/>
			<arg value="PT"/>
			<arg value="Q6"/>
			<arg value="RG"/>
			<arg value="QF"/>
			<arg value="AZ4"/>
			<arg value="UC"/>
			<arg value="UN"/>
			<arg value="UY"/>
			<arg value="AJ"/>
			<arg value="VA"/>
			<arg value="S6"/>
			<arg value="VL"/>
			<arg value="U2"/>
			<arg value="AZ5"/>
			<arg value="AC2"/>
			<arg value="V5"/>
			<arg value="AK"/>
			<arg value="VF"/>
			<arg value="SB"/>
			<arg value="VR"/>
			<arg value="U8"/>
			<arg value="UH"/>
			<arg value="UT"/>
			<arg value="AZ6"/>
			<arg value="QZ"/>
			<arg value="P6"/>
			<arg value="RN"/>
			<arg value="PN"/>
			<arg value="QN"/>
			<arg value="24"/>
			<arg value="RH"/>
			<arg value="PB"/>
			<arg value="QJ"/>
			<arg value="AZ2"/>
			<arg value="AX2"/>
			<arg value="AZD"/>
			<arg value="AZG"/>
			<arg value="A04"/>
			<arg value="VC"/>
			<arg value="SF"/>
			<arg value="UK"/>
			<arg value="UZ"/>
			<arg value="NR"/>
			<arg value="VM"/>
			<arg value="U7"/>
			<arg value="UP"/>
			<arg value="ADU"/>
			<arg value="KI"/>
			<arg value="U3"/>
			<arg value="JI"/>
			<arg value="SA"/>
			<arg value="UE"/>
			<arg value="AZ7"/>
			<arg value="AZJ"/>
			<arg value="N4"/>
			<arg value="A7Y"/>
			<arg value="AZH"/>
			<arg value="AZI"/>
			<arg value="AGW"/>
			<arg value="QW"/>
			<arg value="HU"/>
			<arg value="HV"/>
			<arg value="AJM"/>
			<arg value="V4"/>
			<arg value="P2"/>
			<arg value="RD"/>
			<arg value="S2"/>
			<arg value="N9"/>
			<arg value="PL"/>
			<arg value="RR"/>
			<arg value="VD"/>
			<arg value="HT"/>
			<arg value="ZH"/>
			<arg value="BMG"/>
			<arg value="AIG"/>
			<arg value="AM8"/>
			<arg value="AM9"/>
			<arg value="9Y"/>
			<arg value="AR9"/>
			<arg value="ARA"/>
			<arg value="AMS"/>
			<arg value="AMT"/>
			<classpath>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="fix">
		<java classname="net.sourceforge.fenixedu.applicationTier.Servico.manager.semesterInitialization.FixRoomOccupations"
				fork="true"
				failonerror="true"
				maxmemory="1024m"
				>
			<classpath>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="slide">
		<java classname="net.sourceforge.fenixedu.persistenceTier.fileSupport.JdbcMysqlFileSupport"
				fork="true"
				failonerror="true"
				maxmemory="1024m"
				>
			<classpath>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

</project>
