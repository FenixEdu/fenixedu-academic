<?xml version="1.0" encoding="ISO-8859-1"?>
<project basedir="." default="compile" name="Compilation Scripts">

    <property environment="env"/>
	<property name="encoding" value="ISO-8859-1"/>	

	<property file="build.properties"/>

    <!-- Source code directories -->
    <property name="src" location="src"/>
    <property name="src_gen" location="src_gen"/>    
    <property name="config" location="config"/>
	<property name="config.web" location="metadata"/>

	<!-- Directories for compiled code -->
	<property name="build.home" location="build"/>
	<property name="build.home.webinf" value="${build.home}/WEB-INF"/>
	<property name="build.home.webinf.classes" value="${build.home.webinf}/classes"/>
	<property name="build.home.webinf.libs" value="${build.home.webinf}/lib"/>

	<!-- Directories for deploy -->
	<property name="deploy.home" location="deploy"/>
	
    <!-- Directories with libraries (JARs) -->
    <property name="lib" location="lib" />

    <!-- Directory with SQL instructions -->
    <property name="etc" location="etc"/>

    <!-- Directory with web-content -->
    <property name="web-content" location="jsp"/>

	<!-- DML definition file -->
	<property name="dml.definition.file" value="domain_model.dml"/>

	<!-- Compilation options -->
	<property name="compile.debug"       value="on"/>
  	<property name="compile.deprecation" value="off"/>
  	<property name="compile.optimize"    value="off"/>


    <target name="clean-all"
    		description="Removes any generated files">
		<delete dir="${build.home}"/>
		<delete dir="${deploy.home}"/>
    </target>

	<target name="prepare"
			description="Copy configuration files to compile dir">
		<mkdir dir="${build.home}"/>
		<mkdir dir="${build.home.webinf}"/>
		<mkdir dir="${build.home.webinf.classes}"/>
		<mkdir dir="${build.home.webinf.libs}"/>
		<mkdir dir="${build.home}/images/logs"/>

		<sequential>
			<parallel>
				<copy todir="${build.home}">
					<fileset dir="${web-content}" >
						<include name="**/*.*"/>
						<exclude name="WEB-INF//*.*"/>
					</fileset>
				</copy>

				<copy todir="${build.home.webinf.classes}">
					<fileset dir="${config}"/>
				</copy>

				<copy todir="${build.home.webinf}">
					<fileset dir="${config.web}" >
						<include name="**/*.*"/>
					</fileset>
				</copy>

				<copy todir="${build.home.webinf.libs}">
					<fileset dir="${lib}" >
						<include name="*.jar"/>
						<exclude name="servlet.jar"/>
						<exclude name="jta.jar"/>
					</fileset>
				</copy>
			</parallel>

			<!-- Replace tokens in configuration files with local config -->
			<antcall target="replace-property-values"/>
		</sequential>
	</target>

	<target name="replace-property-values">

		<parallel>
			<replace dir="${build.home.webinf.classes}/OJB/"
					 propertyFile="build.properties">
				<include name="repository_database.xml"/>
				<replacefilter token="@db.user@"
							   property="db.user"/>
				<replacefilter token="@db.pass@" 
							   property="db.pass"/>
				<replacefilter token="@db.name@"
							   property="db.name"/>
				<replacefilter token="@db.alias@"
							   property="db.alias"/>

					<replacefilter token="@db.assiduousness.user@"
								   property="db.assiduousness.user"/>
					<replacefilter token="@db.assiduousness.pass@" 
				    			   property="db.assiduousness.pass"/>
					<replacefilter token="@db.assiduousness.name@" 
								   property="db.assiduousness.name"/>
					<replacefilter token="@db.assiduousness.alias@" 
				    			   property="db.assiduousness.alias"/>
					<replacefilter token="@db.assiduousness.platform@" 
				    			   property="db.assiduousness.platform"/>
					<replacefilter token="@db.assiduousness.driver@" 
				    			   property="db.assiduousness.driver"/>
					<replacefilter token="@db.assiduousness.protocol@" 
				    			   property="db.assiduousness.protocol"/>
					<replacefilter token="@db.assiduousness.subprotocol@" 
				    			   property="db.assiduousness.subprotocol"/>
					<replacefilter token="@db.assiduousness.validationQuery@" 
				    			   property="db.assiduousness.validationQuery"/>
			  		    
					<replacefilter token="@db.personFilter.user@" 
				    			   property="db.personFilter.user"/>
					<replacefilter token="@db.personFilter.pass@" 
				    			   property="db.personFilter.pass"/>
					<replacefilter token="@db.personFilter.name@" 
				    			   property="db.personFilter.name"/>
					<replacefilter token="@db.personFilter.alias@" 
				    			   property="db.personFilter.alias"/>
					<replacefilter token="@db.personFilter.platform@" 
				    			   property="db.personFilter.platform"/>
					<replacefilter token="@db.personFilter.driver@" 
				    			   property="db.personFilter.driver"/>
					<replacefilter token="@db.personFilter.protocol@" 
				    			   property="db.personFilter.protocol"/>
					<replacefilter token="@db.personFilter.subprotocol@" 
				    			   property="db.personFilter.subprotocol"/>
					<replacefilter token="@db.personFilter.validationQuery@" 
				    			   property="db.personFilter.validationQuery"/>
					<replacefilter token="@db.personFilter.other@" 
				    			   property="db.personFilter.other"/>
					<replacefilter token="@db.personFilter.errorFile@" 
				    			   property="db.personFilter.errorFile"/>
					<replacefilter token="@db.personFilter.log@" 
				    			   property="db.personFilter.log"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="Domain.xml"/>
				<replacefilter token="@db.slide.driver@" 
			    			   property="db.slide.driver"/>
				<replacefilter token="@db.slide.alias@" 
			    			   property="db.slide.alias"/>
			    <replacefilter token="@db.slide.user@" 
			    			   property="db.slide.user"/>
			    <replacefilter token="@db.slide.pass@" 
			    			   property="db.slide.pass"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="slide.properties"/>
			    <replacefilter token="@slide.config@" 
			    			   property="slide.config"/>
			</replace>

			<replace dir="${build.home.webinf}/conf"
					 propertyFile="build.properties">
				<include name="struts-default.xml"/>
				<replacefilter token="@application@" 
			    			   property="application"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="IstFtpServerConfig.properties"/>
				<replacefilter 
		                 token="@ftp.IST.server.user@" 
		                 property="ftp.IST.server.user"/>
			  <replacefilter 
	                  token="@ftp.IST.server.pass@" 
	                  property="ftp.IST.server.pass"/>
			  <replacefilter 
	                 token="@ftp.IST.server.address@" 
	                 property="ftp.IST.server.address"/>
	            <replacefilter 
	                 token="@ftp.IST.scp.command@" 
	                 property="ftp.IST.scp.command"/>
			  <replacefilter 
	                 token="@ftp.IST.scp.args@" 
	                 property="ftp.IST.scp.args"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="DegreeGradesFtpServerConfig.properties"/>
	            <replacefilter 
    	             token="@ftp.degree.grades.server.user@" 
	                 property="ftp.degree.grades.server.user"/>
			  <replacefilter 
	                  token="@ftp.degree.grades.server.pass@" 
	                  property="ftp.degree.grades.server.pass"/>
			  <replacefilter 
	                 token="@ftp.degree.grades.server.address@" 
	                 property="ftp.degree.grades.server.address"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="serialization_verifier.properties"/>
				<replacefilter token="@verify_serializable@" 
			    			   property="verify_serializable"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="logAnalyser.properties"/>
				<include name="log4j.xml"/>
				<replacefilter token="@verify_serializable@" 
			    			   property="verify_serializable"/>
			  	<replacefilter token="@log.image.directory@"
			  				   property="log.image.directory"/>
			  	<replacefilter token="@log.profile.dir@"
			  				   property="log.profile.dir"/>
			  	<replacefilter token="@log.profile.filename@"
			  				   property="log.profile.filename"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="OJB.properties"/>
				<replacefilter token="@ObjectCacheClass@"
			    			   property="ObjectCacheClass"/>
				<replacefilter token="@JdbcAccessClass@"
			    			   property="JdbcAccessClass"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="oscache.properties"/>
				<replacefilter token="@cache.event.listeners@"
			    			   property="cache.event.listeners"/>
				<replacefilter token="@cache.cluster.multicast.ip@"
			    			   property="cache.cluster.multicast.ip"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="SMSConfiguration.properties"/>
				<replacefilter token="@sms.gateway.host@"
			    			   property="sms.gateway.host"/>
				<replacefilter token="@sms.gateway.port@"
			    			   property="sms.gateway.port"/>
				<replacefilter token="@sms.gateway.uri@"
			    			   property="sms.gateway.uri"/>
				<replacefilter token="@sms.gateway.protocol@"
			    			   property="sms.gateway.protocol"/>
				<replacefilter token="@sms.gateway.username@"
			    			   property="sms.gateway.username"/>
				<replacefilter token="@sms.gateway.password@"
			    			   property="sms.gateway.password"/>
				<replacefilter token="@sms.delivery.host@"
			    			   property="sms.delivery.host"/>
				<replacefilter token="@sms.delivery.port@"
			    			   property="sms.delivery.port"/>
				<replacefilter token="@sms.delivery.uri@"
			    			   property="sms.delivery.uri"/>
				<replacefilter token="@sms.delivery.protocol@"
			    			   property="sms.delivery.protocol"/>
				<replacefilter token="@sms.delivery.username@"
			    			   property="sms.delivery.username"/>
				<replacefilter token="@sms.delivery.password@"
			    			   property="sms.delivery.password"/>
			</replace>
		
			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="GratuitySituationCreatorTask.properties"/>
				<replacefilter token="@gratuity.situation.creator.task.hour@"
		    			   property="gratuity.situation.creator.task.hour"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="configurationSQLInstructions.properties"/>
				<replacefilter token="@roleback.filename@"
		    			   property="roleback.filename"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="log4j.xml"/>
				<replacefilter token="@log4j.email.smtp.host@"
							   property="log4j.email.smtp.host"/>
				<replacefilter token="@log4j.email.smtp.from@"
							   property="log4j.email.smtp.from"/>
				<replacefilter token="@log4j.email.smtp.to@"
							   property="log4j.email.smtp.to"/>
				<replacefilter token="@log4j.email.smtp.subject@"
							   property="log4j.email.smtp.subject"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="projectsManagement.properties"/>
				<replacefilter token="@db.projectManagement.user@"
							   property="db.projectManagement.user"/>
				<replacefilter token="@db.projectManagement.pass@"
							   property="db.projectManagement.pass"/>
				<replacefilter token="@db.projectManagement.alias@"
							   property="db.projectManagement.alias"/>
			</replace>

			<replace dir="${build.home.webinf.classes}/ServidorApresentacao"
					 propertyFile="build.properties">
				<include name="ApplicationResources.properties"/>
				<include name="ApplicationResourcesSOP.properties"/>
				<include name="ManagerResources.properties"/>
			  	<replacefilter token="@login.page@"
			  				   property="login.page"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="logAnalyser.properties"/>
			  	<replacefilter token="@login.page@"
			  				   property="login.page"/>
			  	<replacefilter token="@log.image.directory@"
			  				   property="log.image.directory"/>
			  	<replacefilter token="@log.profile.dir@"
			  				   property="log.profile.dir"/>
			  	<replacefilter token="@log.profile.filename@"
			  				   property="log.profile.filename"/>
			</replace>

			<replace dir="${build.home.webinf.classes}"
					 propertyFile="build.properties">
				<include name="web.xml"/>
				<replacefilter 
				    token="@app.context@"
				    property="app.context"/>
			</replace>

			<replace dir="${build.home}"
					 propertyFile="build.properties">
				<include name="index.html"/>
				<replacefilter 
				    token="@index.html.link@" 
				    property="index.html.link"/>
			</replace>
		
			<replace dir="${build.home}"
					 propertyFile="build.properties">
				<include name="publico/index.html"/>
				<include name="publico/degreeSite/mainNavigation_without_teaching.jsp"/>
				<replacefilter 
					    token="@institution.url@" 
					    property="institution.url"/>
			</replace>

			<replace dir="${build.home}"
					 propertyFile="build.properties">
				<include name="student/enrollment/warning.jsp"/>
				<include name="degreeAdministrativeOffice/enrolment/withRules/enrollmentConfirmation.jsp"/>
				<include name="degreeAdministrativeOffice/enrolment/withRules/prepareEnrollmentChooseCurricularCourses.jsp"/>
	            <replacefilter token="@enrollment.faq.url@"
			    			   property="enrollment.faq.url"/>    
			</replace>
		</parallel>
	</target>

    <target name="write-filter-hostnames-configuration-file">
    	<delete file=".authenticationServiceHostnamesFiltering.properties.xml"/>
    	<delete file="${build.home.webinf.classes}/.authenticationServiceHostnamesFiltering.properties"/>
    	<property name="ant.regexp.regexpimpl" value="org.apache.tools.ant.util.regexp.Jdk14RegexpRegexp"/>
		<concat destfile=".authenticationServiceHostnamesFiltering.properties.xml">
			${filter.hostnames}
			<filterchain>
				<tokenfilter>
					<ignoreblank/>
					<trim/>
					<stringtokenizer delims="," delimsaretokens="true" includeDelims="false"/>
					<replaceregex pattern="(.*)" replace="\1${line.seperator}"/>
				</tokenfilter>
				<tokenfilter>
				    <replacestring from="," to=""/>
					<trim/>
					<ignoreblank/>
				</tokenfilter>
				<prefixlines prefix="@filter.hostname."/>
				<prefixlines prefix="file='${build.home.webinf.classes}/.authenticationServiceHostnamesFiltering.properties'>"/>
				<prefixlines prefix="append='true' "/>
				<prefixlines prefix="${character.lessthan}echo "/>
				<tokenfilter>
					<stringtokenizer delims="${line.seperator}" delimsaretokens="false" includeDelims="false"/>
					<replaceregex pattern="(.*)"
						flags="s"
						replace="\1@${allowed-roles.newline.instruction}${character.lessthan}/echo>"/>
				</tokenfilter>
				<tokenfilter>
					<stringtokenizer delims="${line.seperator}" delimsaretokens="false" includeDelims="false"/>
					<replaceregex pattern="@(.*)@"
						flags="s"
						replace="\1=${character.dollar}{\1}"/>
				</tokenfilter>
				<tokenfilter>
					<stringtokenizer delims="@@@@@@" delimsaretokens="false" includeDelims="false"/>
					<replaceregex pattern="(.*)"
						flags="s"
						replace="${allowed-roles.build.file.constructor.header}\1${allowed-roles.build.file.constructor.tail}"/>
				</tokenfilter>
				<escapeunicode/>
			</filterchain>
		</concat>
		<ant antfile=".authenticationServiceHostnamesFiltering.properties.xml"/>
    	<delete file=".authenticationServiceHostnamesFiltering.properties.xml"/>
	</target>

	<target name="generate"
	                description="Generate java code from a DML file">
		<echo message="Processing ${dml.definition.file} ..."/>
		<delete dir="${src_gen}"/>
		<mkdir dir="${src_gen}"/>
		<java classname="dml.DmlCompiler" fork="true">
			<arg value="-f"/>
			<arg value="-d"/>
			<arg value="${src_gen}"/>
			<arg value="${config}/${dml.definition.file}"/>
			<classpath>
				<fileset dir="${lib}">
					<include name="dml.jar"/>
					<include name="antlr.jar"/>
				</fileset>
			</classpath>
		</java>
		<delete includeEmptyDirs="true">
			<fileset dir="${src_gen}">
				<include name="**/*.java"/>
				<include name="**/Item.java"/>
				<include name="**/InsuranceValue.java"/>
				<include name="**/InsuranceTransaction.java"/>
				<exclude name="**/*_Base.java"/>
				<exclude name="**/I*.java"/>
			</fileset>
	    </delete>
		<echo level="info" message="Processing of ${dml.definition.file} finished."/>
	</target>

    <target name="compile"
    		description="Compile application"
    		depends="prepare, write-filter-hostnames-configuration-file, generate">
		<javac destdir="${build.home.webinf.classes}"
               extdirs="${lib};${env.JBOSS_HOME}/client"
               debug="${compile.debug}"
               optimize="${compile.optimize}"
               deprecation="${compile.deprecation}"
               encoding="${encoding}"
			   nowarn="true">
			<src path="${src_gen}"/>
			<src path="${src}"/>
		</javac>
	</target>

    <target name="includeJ2EEjar"
            description="Copies j2ee jar to deploy dir.">

		<copy todir="${build.home.webinf.libs}">
			<fileset dir="${env.JBOSS_HOME}/client">
				<include name="jboss-j2ee.jar"/>
			</fileset>
		</copy>
	</target>

    <target name="install"
    		depends="compile, includeJ2EEjar"
            description="Deploys standalone application to web server">

		<!-- Run this externally so it doesn't fail when
			 the web-app is not yet installed. -->
		<exec executable="ant.bat" failonerror="false" failifexecutionfails="false" os="Windows XP, Windows 2000, Windows 98, Windows NT, Windows 95">
			<arg line="-f"/>
			<arg line="build_tomcat.xml"/>			
			<arg line="remove"/>			
		</exec> 
		<exec executable="ant" failonerror="false" os="Linux">
			<arg line="-f"/>
			<arg line="build_tomcat.xml"/>			
			<arg line="remove"/>			
		</exec>

		<!-- Install web-app -->
		<ant antfile="build_tomcat.xml" target="install">
			<property name="webapp" value="${build.home}"/>
		</ant>
	</target>

    <target name="jar"
    		depends="compile"
            description="Generates a java archive applications 'core' (services and domain).">
		<mkdir dir="${deploy.home}"/>
		<jar destfile="${deploy.home}/${app.name}.jar">
			<fileset dir="${build.home.webinf.classes}">
				<include name="net/sourceforge/fenixedu/_development/**/*.class"/>
	       		<include name="net/sourceforge/fenixedu/constants/**/*.class"/>
				<include name="net/sourceforge/fenixedu/commons/**/*.class"/>
	       		<include name="net/sourceforge/fenixedu/dataTransferObject/**/*.class"/>
	       		<include name="net/sourceforge/fenixedu/domain/**/*.class"/>
	       		<include name="net/sourceforge/fenixedu/fileSuport/**/*.class"/>
	       		<include name="net/sourceforge/fenixedu/middleware/**/*.class"/>
	       		<include name="net/sourceforge/fenixedu/applicationTier/**/*.class"/>
	       		<include name="net/sourceforge/fenixedu/persistenceTier/**/*.class"/>
	       		<include name="net/sourceforge/fenixedu/persistenceTierFiltroPessoa/**/*.class"/>
	       		<include name="net/sourceforge/fenixedu/persistenceTierJDBC/**/*.class"/>
	       		<include name="net/sourceforge/fenixedu/persistenceTierOracle/**/*.class"/>
	       		<include name="net/sourceforge/fenixedu/util/**/*.class"/>
	       		<include name="net/sourceforge/fenixedu/utilInsc/**/*.class"/>
	       		<include name="net/sourceforge/fenixedu/utilTests/**/*.class"/>
	       		<include name="net/sourceforge/fenixedu/tools/**/*.class"/>
				<include name="org/**/*.class"/>
			</fileset>
		</jar>
	</target>

    <target name="war"
	    	depends="compile, includeJ2EEjar"
            description="Generates a web archive of the application.">
    	<mkdir dir="${deploy.home}"/>
		<war destfile="${deploy.home}/${app.name}.war" webxml="${build.home.webinf}/web.xml">
			<fileset dir="${build.home}">
				<exclude name="WEB-INF/web.xml"/>
				<exclude name="WEB-INF/classes/**"/>
				<exclude name="WEB-INF/lib/*"/>
			</fileset>
			<lib dir="${build.home.webinf.libs}"/>
			<classes dir="${build.home.webinf.classes}"/>
		</war>
	</target>

</project>
