<?xml version="1.0" encoding="ISO-8859-1"?>
<project basedir="." default="MigrateData" name="CIAPL">

	<property name="sshtools.home" location="lib"/>

    <property environment="env"/>

	<property file="build.properties"/>

    <!-- Directorios com codigo fonte -->
    <property name="src" location="src"/>
	<property name="build.home" location="build"/>

    <!-- Directorios destino da compilacao do projecto -->
	<property name="webapp"          location="${build.home}/app"/>
    <property name="webapp.metadata" value="${webapp}/WEB-INF"/>
    <property name="webapp.classes"  value="${webapp.metadata}/classes"/>
    <property name="webapp.lib"      value="${webapp.metadata}/lib"/>

    <!-- Directorio com bibliotecas (JAR) a utilizar -->
    <property name="lib" location="lib"/>
	<property location="lib_web" name="libs.web"/>

    <!-- Directorio com configuracoes -->
    <property location="config" name="config"/>

    <!-- Directorio com instrucoes SQL -->
    <property location="etc" name="sql"/>

	<!-- Compilation options -->
	<property name="compile.debug"       value="on"/>
  	<property name="compile.deprecation" value="on"/>
  	<property name="compile.optimize"    value="on"/>

	<property name="encoding" value="ISO-8859-15"/>	

    <target name="clean-all" description="Removes any generated files">
		<delete dir="${build.home}"/>
    </target>

	<target name="prepare">
		<!-- Create build directories as needed -->
		<mkdir dir="${webapp.classes}"/>	
		<mkdir dir="${webapp.lib}"/>

		<!-- Copy external dependencies as required -->
		<copy todir="${webapp.metadata}">
			<fileset dir="${basedir}/metadata"/>    
		</copy>

		<copy todir="${webapp.lib}">
			<fileset dir="${basedir}/lib">    
				<exclude name="servlet.jar"/>
				<exclude name="strutstest.jar"/>
			</fileset>
			<fileset dir="${basedir}/lib_web">
				<exclude name="servlet.jar"/>
				<exclude name="strutstest.jar"/>
			</fileset>
		</copy>

		<copy todir="${webapp.classes}">
			<fileset dir="${basedir}/config"/>
		</copy>
	</target>
  
    <target name="compile-proj"
            description="Compila o projecto principal" depends="prepare">
        <tstamp/>
        <javac destdir="${webapp.classes}"
               extdirs="${lib};${libs.web}"
               debug="${compile.debug}"
               optimize="${compile.optimize}"
               deprecation="${compile.deprecation}"
               encoding="${encoding}"
               memoryInitialSize="512m"
               memoryMaximumSize="512m"
               fork="yes">
			<src path="${src}"/>
        </javac>
		<replace dir="${webapp.metadata}" propertyFile="build.properties">
	    	<include name="**/**/*.xml"/>
	    	<include name="**/**/ApplicationResources.properties"/>
	    	<include name="**/ServidorPersistenteConfig.properties"/>
	    	<include name="**/ServidorPersistenteOracleConfig.properties"/>

			<replacefilter token="&lt;!-- @validation.doctype@ -->" property="validation.doctype"/>

			<replacefilter token="@login.page@" property="login.page"/>

			<replacefilter token="@db.user@" property="db.user"/>
			<replacefilter token="@db.pass@" property="db.pass"/>
			<replacefilter token="@db.name@" property="db.name"/>
			<replacefilter token="@db.alias@" property="db.alias"/>

			<replacefilter token="@application@" property="application"/>
		</replace>
    </target>

    <target name="create-tables" description="Cria as tabelas da base de dados.">
        <sql
            driver="com.mysql.jdbc.Driver"
            url="jdbc:mysql://localhost/${db.name}"
            userid="${db.user}"
            password="${db.pass}"
            encoding="${encoding}">
	        <fileset dir="${sql}">
				<include name="middleware/createTables.sql"/>
  			</fileset>
            <classpath>
                <fileset dir="${lib}">
                    <include name="**/*.jar"/>
                </fileset>
            </classpath>
        </sql>
    </target>

	<target name="replace-tokens">
        <delete file="${sql}/middleware/PopulateTables_generated.sql"/>
		<copy file="${sql}/middleware/PopulateTables.sql" toFile="${sql}/middleware/PopulateTables_generated.sql"/>		
		<replace dir="${sql}/middleware" propertyFile="middleware.properties">
	    	<include name="PopulateTables_generated.sql"/>
		    <replacefilter token="@load.data.infile.root@" property="load.data.infile.root"/>
		    <replacefilter token="@load.data.infile.rootIleec@" property="load.data.infile.rootIleec"/>
    	</replace>
	</target>

    <target name="load-data-from-old-system" depends="create-tables, replace-tokens" description="Carrega os dados nas tabelas">
        <sql
            driver="com.mysql.jdbc.Driver"
            url="jdbc:mysql://localhost/${db.name}"
            userid="${db.user}"
            password="${db.pass}"
            encoding="${encoding}">
	        <fileset dir="${sql}">
				<include name="middleware/PopulateTables_generated.sql" />
  			</fileset>
            <classpath>
                <fileset dir="${lib}">
                    <include name="**/*.jar"/>
                </fileset>
            </classpath>
        </sql>
    </target>

	<!-- ********************** ENROLLMENT MIGRATION RELATED ********************** -->
    <target name="create-MWCurricularCourseOutsideStudentDegree-table">
        <sql driver="com.mysql.jdbc.Driver"
            url="jdbc:mysql://localhost/${db.name}"
            userid="${db.user}"
            password="${db.pass}"
            encoding="${encoding}">
	        <fileset dir="${sql}">
			 <include name="middleware/allEnrollmentsMigration/createMWCurricularCourseOutsideStudentDegreeTable.sql"/>
  			</fileset>
            <classpath>
                <fileset dir="${lib}">
                    <include name="**/*.jar"/>
                </fileset>
            </classpath>
        </sql>
    </target>

	<target name="load-mw-tables-with-data-for-all-enrollment-migration" depends="compile-proj, load-data-from-old-system" description="Loads tables mw_ENROLMENT, mw_CURRICULAR_COURSE_SCOPE and mw_STUDENT with data for all enrollment migration">
		<sequential>
			<sql driver="com.mysql.jdbc.Driver" url="jdbc:mysql://localhost/${db.name}" userid="${db.user}" password="${db.pass}" encoding="${encoding}">
				<fileset dir="${sql}">
					<include name="middleware/allEnrollmentsMigration/loadMWTablesWithDataForAllEnrollmentMigration.sql"/>
				</fileset>
				<classpath>
					<fileset dir="${lib}">
						<include name="**/*.jar"/>
					</fileset>
				</classpath>
			</sql>
		</sequential>
	</target>

	<target name="create-past-execution-periods-and-execution-years" depends="load-mw-tables-with-data-for-all-enrollment-migration">
		<exec executable="${sql}/middleware/commands/createPastExecutionPeriodsAndExecutionYears.sh" os="Linux, Unix">
			<arg value="stop"/>
		</exec>
		<exec executable="${sql}/middleware/commands/createPastExecutionPeriodsAndExecutionYears.bat" vmlauncher="true" os="Windows, Windows 2000, Windows XP">
		</exec>
	</target>

	<!-- <target name="create-and-update-all-past-curriculums" depends="create-past-execution-periods-and-execution-years"> -->
	<target name="create-and-update-all-past-curriculums" depends="compile-proj">
		<java classname="middleware.studentMigration.enrollments.CreateAndUpdateAllPastCurriculums" fork="yes" failonerror="false" maxmemory="512m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<!--<target name="create-and-update-all-students-enrolments" depends="create-and-update-all-past-curriculums">-->
	<target name="create-and-update-all-students-enrolments" depends="compile-proj">
		<java classname="middleware.studentMigration.enrollments.CreateAndUpdateAllStudentsPastEnrolments" fork="yes" failonerror="false" maxmemory="512m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="create-and-update-attends-for-all-master-degree-students" depends="compile-proj">
		<java classname="middleware.studentMigration.CreateAndUpdateAttendsForAllMasterDegreeStudents" fork="yes" failonerror="false" maxmemory="512m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="migrate-all-student-curricular-plans" depends="compile-proj, load-data-from-old-system">
		<exec executable="${sql}/middleware/commands/migrateAllStudenCurricularPlans.sh" os="Linux, Unix">
			<arg value="stop"/>
		</exec>
		<exec executable="${sql}/middleware/commands/migrateAllStudenCurricularPlans.bat" vmlauncher="true" os="Windows, Windows 2000, Windows XP">
		</exec>
	</target>
	<!-- ************************************************************************** -->

	<!-- ********************** DATABASE CLEANING RELATED ********************** -->
	<target name="create-branch-codes-and-acronyms" depends="compile-proj">
		<java classname="middleware.databaseClean.branches.CreateBranchCodesAndAcronyms" fork="yes" failonerror="false" maxmemory="512m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="change-relation-between-CCScope-and-CC-of-mathAnalysisA" depends="compile-proj">
		<java classname="middleware.databaseClean.curricularCourseScopes.ChangeRelationBetweenCCScopeAndCCOfMathAnalysisA.java" fork="yes" failonerror="false" maxmemory="512m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="delete-alterative-curricularCourseScopes" depends="compile-proj">
		<java classname="middleware.databaseClean.curricularCourseScopes.DeleteAlterativeCurricularCourseScopes.java" fork="yes" failonerror="false" maxmemory="512m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="update-enrollmentEvaluations-dates-for-all-students-past-enrolments" depends="load-mw-tables-with-data-for-all-enrollment-migration">
		<java classname="middleware.studentMigration.enrollments.UpdateEnrollmentEvaluationsDatesForAllStudentsPastEnrolments" fork="yes" failonerror="false" maxmemory="512m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>
	<!-- *********************************************************************** -->

	<!-- ********************** EQUIVALENCE MIGRATION RELATED ********************** -->
	<target name="make-equivalences-for-all-students-past-enrolments" depends="compile-proj">
		<java classname="middleware.studentMigration.equivalences.MakeEquivalencesForAllStudentsPastEnrolments" fork="yes" failonerror="false" maxmemory="512m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>
	<!-- *************************************************************************** -->

	<!-- ********************** ILEEC MIGRATION RELATED ********************** -->
	<target name="replace-tokens-for-ileec">
		<delete file="${sql}/middleware/PopulateTables_generated.sql"/>
		<copy file="${sql}/middleware/ileec/populateTablesIleec.sql" toFile="${sql}/middleware/PopulateTables_generated.sql"/>
		<replace dir="${sql}/middleware" propertyFile="middleware.properties">
			<include name="PopulateTables_generated.sql"/>
			<replacefilter token="@load.data.infile.rootIleec@" property="load.data.infile.rootIleec"/>
		</replace>
	</target>

	<target name="create-tables-ileec" depends="" description="Cria as tabelas de middleware para suportar os dados do ILEEC">
		<sql driver="com.mysql.jdbc.Driver" url="jdbc:mysql://localhost/${db.name}" userid="${db.user}" password="${db.pass}" encoding="${encoding}">
			<fileset dir="${sql}">
				<include name="middleware/ileec/createTablesIlecc.sql"/>
			</fileset>
			<classpath>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</sql>
	</target>

	<target name="load-ileec-data" depends="create-tables-ileec, replace-tokens-for-ileec" description="Carrega os dados do ILEEC nas tabelas de middleware">
		<sql driver="com.mysql.jdbc.Driver" url="jdbc:mysql://localhost/${db.name}" userid="${db.user}" password="${db.pass}" encoding="${encoding}">
			<fileset dir="${sql}">
				<include name="middleware/PopulateTables_generated.sql"/>
			</fileset>
			<classpath>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</sql>
	</target>

	<target name="make-equivalences-for-ileec-students" depends="compile-proj, load-ileec-data" description="Cria na BD do Fénix as equivalências do ILEEC">
		<java classname="middleware.studentMigration.equivalences.MakeEquivalencesForILEECStudents" fork="yes" failonerror="false" maxmemory="512m">
			<classpath>
				<pathelement path="${webapp.classes}"/>
				<pathelement path="${config}"/>
				<pathelement path="${sql}"/>
				<pathelement path="${src}"/>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>
	<!-- ********************************************************************* -->
</project>