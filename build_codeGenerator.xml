<?xml version="1.0" encoding="ISO-8859-1"?>
<project basedir="." default="compile" name="Compilation Scripts">

    <property environment="env"/>
	<property name="encoding" value="ISO-8859-1"/>	

	<property file="build.properties"/>

	<property name="config" location="config"/>

    <!-- Source code directories -->
    <property name="src" location="src"/>
    <property name="src_gen" location="src_gen"/>    
    <property name="src_tools" location="src_tools"/>

	<!-- Directories for compiled code -->
	<property name="build.home" location="build"/>
	<property name="build.home.temp" value="${build.home}/temp"/>
	<property name="build.home.temp.classes" value="${build.home.temp}/classes"/>
	<property name="build.home.webinf" value="${build.home}/WEB-INF"/>
	<property name="build.home.webinf.classes" value="${build.home.webinf}/classes"/>

    <!-- Directories with libraries (JARs) -->
    <property name="lib" location="lib" />

	<!-- Compilation options -->
	<property name="compile.debug"       value="on"/>
  	<property name="compile.deprecation" value="off"/>
  	<property name="compile.optimize"    value="on"/>

	<property name="dml.definition.file" value="${config}/domain_model.dml"/>
	<property name="dml.definition.file.completed" value="${build.home.webinf.classes}/domain_model.dml"/>
	<property name="dml.fenix.sqltypes" value="${config}/dataTypesJDBCTypes.properties"/>
	<property name="dml.fenix.typeconverters" value="${config}/dataTypeConversors.properties"/>

	  <path id="classpath.analysis">
	    <pathelement path="${build.home.temp.classes}"/>
	    <fileset dir="${lib}">
	      <include name="**/*.jar"/>
	    </fileset>
	  </path>

	<target name="generate-domain"
	                description="Generate java code from a DML file">
		<echo message="Processing ${dml.definition.file.completed} ..."/>
		<delete dir="${src_gen}"/>
		<mkdir dir="${src_gen}"/>
		<java classname="dml.DmlCompiler" fork="true">
                        <jvmarg value="-Ddml.fenix.sqltypes=${dml.fenix.sqltypes}"/>
                        <jvmarg value="-Ddml.fenix.typeconverters=${dml.fenix.typeconverters}"/>
			<arg value="-f"/>
			<arg value="-d"/>
			<arg value="${src}"/>
			<arg value="-db"/>
			<arg value="${src_gen}"/>
<!--			<arg value="-gf"/>-->
			<arg value="-generator"/>
			<arg value="dml.FenixCodeGeneratorReadFromRs"/>
			<arg value="${dml.definition.file.completed}"/>
			<classpath>
				<fileset dir="${lib}">
					<include name="dml.jar"/>
					<include name="dml-runtime.jar"/>
					<include name="antlr.jar"/>
				</fileset>
			</classpath>
		</java>
		<echo level="info" message="Processing of ${dml.definition.file.completed} finished."/>
	</target>

    <target name="update-RootDomainObject"
    		description="Adds specific readByOID methods to RootDomainObject.">
		<java classname="pt.utl.ist.fenix.tools.codeGenerator.RootDomainObjectGenerator" fork="true">
			<arg value="${src_gen}"/>
			<arg value="${dml.definition.file.completed}"/>
			<classpath>
				<pathelement path="${build.home.temp.classes}"/>			
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
    	<antcall target="clean-all"/>
    </target>
	
    <target name="clean-all"
    		description="Removes any generated files">
		<delete dir="${build.home.temp}"/>
    </target>

	<target name="prepare"
			description="Copy configuration files to compile dir">
		<mkdir dir="${build.home}"/>
		<mkdir dir="${build.home.temp}"/>
		<mkdir dir="${build.home.temp.classes}"/>
		<mkdir dir="${build.home.webinf}"/>
		<mkdir dir="${build.home.webinf.classes}"/>

		<javac destdir="${build.home.webinf.classes}"
               extdirs="${lib}"
               debug="${compile.debug}"
               optimize="${compile.optimize}"
               deprecation="${compile.deprecation}"
               encoding="${encoding}"
			   nowarn="true">
			<src path="${src_gen}"/>
			<src path="${src}"/>
			<include name="net/sourceforge/fenixedu/persistenceTier/OJB/SuportePersistenteOJB.java"/>
			<include name="net/sourceforge/fenixedu/persistenceTier/versionedObjects/VersionedObjectsBase.java"/>
			<include name="net/sourceforge/fenixedu/persistenceTier/versionedObjects/VersionedObjectsPersistenceSupport.java"/>
			<include name="net/sourceforge/fenixedu/persistenceTier/delegatedObjects/DAOResultComparator.java"/>
			<include name="net/sourceforge/fenixedu/persistenceTier/delegatedObjects/DAOResultLogger.java"/>
		</javac>
	</target>

    <target name="compile"
    		description="Compile tools"
    		depends="prepare">
		<javac destdir="${build.home.temp.classes}"
			   classpath="${build.home.webinf.classes}"
               extdirs="${lib}"
               debug="${compile.debug}"
               optimize="${compile.optimize}"
               deprecation="${compile.deprecation}"
               encoding="${encoding}"
			   nowarn="true">
			<src path="${src_tools}"/>
		</javac>
	</target>

    <target name="generate-OJBMetadata"
    		description="Adds specific readByOID methods to RootDomainObject."
    		depends="compile">
		<java classname="net.sourceforge.fenixedu.tools.OJBMetadataGenerator" fork="true">
			<arg value="${dml.definition.file.completed}"/>
			<arg value="${class}"/>
			<classpath>
				<pathelement path="${build.home.temp.classes}"/>	
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
    </target>	

    <target name="generate-OJBMetadataWithDebug"
    		description="Adds specific readByOID methods to RootDomainObject."
    		depends="compile">
		<java classname="net.sourceforge.fenixedu.tools.OJBMetadataGenerator" fork="true" 
			jvmargs="-Xdebug -Xnoagent -Djava.compiler=NONE  -Xrunjdwp:transport=dt_socket,server=y,address=8000,suspend=y"
		>
			<arg value="${dml.definition.file.completed}"/>
			<arg value="${option}"/>
			<classpath>
				<pathelement path="${build.home.temp.classes}"/>	
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
    </target>

    <target name="fixColumnsNames"
    		depends="compile">
		<java classname="net.sourceforge.fenixedu.tools.FixColumnsNames" fork="true">
			<classpath>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
    </target>

	<target name="fixColumnsNames-debug"
    		depends="compile">
		<java classname="net.sourceforge.fenixedu.tools.FixColumnsNames" fork="true"
			jvmargs="-Xdebug -Xnoagent -Djava.compiler=NONE  -Xrunjdwp:transport=dt_socket,server=y,address=8000,suspend=y"
		>
			<classpath>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
    </target>
	
    <target name="changeVarcharColumnsToLongvarcharColumns"
    		depends="compile">
		<java classname="net.sourceforge.fenixedu.tools.ChangeVarcharColumnsToLongvarcharColumns" fork="true">
			<classpath>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
    </target>
				
	<target name="changeDMLDateTypes"
    		depends="compile">
		<java classname="net.sourceforge.fenixedu.tools.CheckAndFixDMLDateTypes" fork="true">
			<arg value="${dml.definition.file.completed}"/>
			<classpath>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
    </target>
	
	<target name="changeDMLDateTypes-debug"
    		depends="compile">
		<java classname="net.sourceforge.fenixedu.tools.CheckAndFixDMLDateTypes" fork="true"
			jvmargs="-Xdebug -Xnoagent -Djava.compiler=NONE  -Xrunjdwp:transport=dt_socket,server=y,address=8000,suspend=y"			
		>
			<arg value="${dml.definition.file.completed}"/>
			<classpath>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
    </target>	
		
	<target name="checkConversors"
    		depends="compile">
		<java classname="net.sourceforge.fenixedu.tools.CheckOJBConversors" fork="true">
			<arg value="${dml.definition.file.completed}"/>
			<classpath>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
    </target>
	
	<target name="checkConversors-debug"
    		depends="compile">
		<java classname="net.sourceforge.fenixedu.tools.CheckOJBConversors" fork="true"
			jvmargs="-Xdebug -Xnoagent -Djava.compiler=NONE  -Xrunjdwp:transport=dt_socket,server=y,address=8000,suspend=y"
		>
			<arg value="${dml.definition.file.completed}"/>
			<classpath>
				<pathelement path="${build.home.webinf.classes}"/>
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
    </target>
	
    <target name="generateDeprecatedDateGettersAndSetters" >
		<java classname="pt.utl.ist.fenix.tools.codeGenerator.DeprecatedDatesGettersAndSettersGenerator" fork="true">
			<arg value="${src_gen}"/>
			<arg value="${dml.definition.file.completed}"/>
			<classpath>
				<pathelement path="${build.home.temp.classes}"/>			
				<fileset dir="${lib}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</java>
    	<antcall target="clean-all"/>
    </target>	
	
	<!--
		Groups Language
	  -->
	
	<property name="groups.language.file" value="${config}/groups-language.g"/>
	<property name="groups.output.dir" value="${src_gen}/net/sourceforge/fenixedu/domain/accessControl/groups/language/"/>
	
	<target name="check-groups-language">
		<uptodate property="groups.language.changed" targetfile="${groups.language.file}">
			<srcfiles dir="${groups.output.dir}" includes="**/*.*"/>
		</uptodate>
	</target>
	
	<target name="prepare-groups-output-dir">
		<mkdir dir="${groups.output.dir}"/>
	</target>
		
	<target name="show-groups-message" unless="groups.language.changed">
		<echo message="No need to compile groups language grammar: ${groups.language.file}"/>
	</target>

	<target name="generate-groups-language" description="Generates the parser for the groups language"
			depends="prepare-groups-output-dir,check-groups-language,show-groups-message"
			if="groups.language.changed">
		<antlr target="${groups.language.file}" outputdirectory="${groups.output.dir}">
			<classpath>
				<fileset dir="${lib}">
					<include name="**/antlr.jar"/>
				</fileset>
			</classpath>
		</antlr>
	</target>
	
</project>
